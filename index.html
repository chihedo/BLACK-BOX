<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BLACK BOX</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Noto+Serif+JP:wght@300;400;700&family=IBM+Plex+Mono:wght@300;400;700&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --black: #000000;
  --white: #ffffff;
  --red: #ff2020;
  --dim: #111111;
  --mid: #222222;
  --border: #333333;
  --muted: #aaaaaa;
  --text-muted: #888888;
}

html { scroll-behavior: smooth; }

body {
  background: var(--black);
  color: var(--white);
  font-family: 'Noto Serif JP', serif;
  min-height: 100vh;
  cursor: crosshair;
  overflow-x: hidden;
}

/* SCANLINES */
body::after {
  content: '';
  position: fixed;
  inset: 0;
  background: repeating-linear-gradient(
    0deg,
    transparent,
    transparent 2px,
    rgba(255,255,255,0.012) 2px,
    rgba(255,255,255,0.012) 4px
  );
  pointer-events: none;
  z-index: 999;
}

/* CUSTOM CURSOR */
* { cursor: crosshair; }
button, a { cursor: crosshair; }

/* HEADER */
header {
  position: fixed;
  top: 0; left: 0; right: 0;
  z-index: 100;
  display: flex;
  align-items: stretch;
  border-bottom: 1px solid var(--border);
  background: rgba(0,0,0,0.95);
  backdrop-filter: blur(10px);
  height: 70px;
}

.logo-wrap {
  display: flex;
  align-items: center;
  padding: 0 2rem;
  border-right: 1px solid var(--border);
  gap: 1rem;
  text-decoration: none;
}

.logo-box {
  width: 28px; height: 28px;
  background: var(--white);
  display: flex;
  align-items: center;
  justify-content: center;
}

.logo-box-inner {
  width: 10px; height: 10px;
  background: var(--black);
}

.logo-text {
  font-family: 'Bebas Neue', sans-serif;
  font-size: 1.4rem;
  letter-spacing: 0.25em;
  color: var(--white);
}

nav {
  display: flex;
  align-items: stretch;
  margin-left: auto;
}

nav a {
  display: flex;
  align-items: center;
  padding: 0 0.75rem;
  font-family: 'IBM Plex Mono', monospace;
  font-size: 0.55rem;
  letter-spacing: 0.08em;
  color: #555;
  text-decoration: none;
  border-left: 1px solid var(--border);
  transition: all 0.2s;
  text-transform: uppercase;
  white-space: nowrap;
}

nav a:hover { color: var(--white); background: var(--dim); }

nav a.active { color: var(--white); }

.nav-post {
  background: var(--white) !important;
  color: var(--black) !important;
  font-weight: 700 !important;
  transition: all 0.2s !important;
}

.nav-post:hover { background: var(--red) !important; color: var(--white) !important; }

.nav-avatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: var(--white);
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  transition: background 0.2s;
  flex-shrink: 0;
}

.nav-avatar:hover { background: var(--red); }
.nav-avatar img { width: 100%; height: 100%; object-fit: cover; }
.nav-avatar svg { display: block; }

.nav-avatar-wrap {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 0.2rem;
  padding: 0 0.75rem;
  border-left: 1px solid var(--border);
  cursor: crosshair;
  transition: background 0.2s;
  height: 100%;
  min-width: 60px;
}

.nav-avatar-wrap:hover { background: var(--dim); }

.nav-avatar-name {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 0.5rem;
  letter-spacing: 0.1em;
  color: #888;
}

/* HERO */
.hero {
  padding-top: 70px;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  justify-content: center;
  padding-left: 4rem;
  padding-right: 4rem;
  position: relative;
  overflow: hidden;
  background: linear-gradient(135deg, #000000 0%, #0a0a0a 60%, #111111 100%);
}

.hero-bg-text {
  position: absolute;
  right: -2rem;
  top: 50%;
  transform: translateY(-50%);
  font-family: 'Bebas Neue', sans-serif;
  font-size: clamp(12rem, 25vw, 22rem);
  color: rgba(255,255,255,0.015);
  letter-spacing: -0.05em;
  line-height: 0.85;
  pointer-events: none;
  user-select: none;
}

.hero-eyebrow {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 0.7rem;
  letter-spacing: 0.4em;
  color: var(--red);
  text-transform: uppercase;
  margin-bottom: 2rem;
  display: flex;
  align-items: center;
  gap: 1rem;
  animation: fade-in 0.8s ease both;
}

.hero-eyebrow::before {
  content: '';
  display: block;
  width: 40px;
  height: 1px;
  background: var(--red);
}

.hero-h1 {
  font-family: 'Bebas Neue', sans-serif;
  font-size: clamp(4rem, 10vw, 9rem);
  line-height: 0.92;
  letter-spacing: 0.02em;
  margin-bottom: 3rem;
  color: var(--white);
  animation: fade-in 0.8s 0.1s ease both;
  text-shadow: 0 2px 20px rgba(0,0,0,0.8);
}

.hero-h1 .line2 {
  color: transparent;
  -webkit-text-stroke: 1.5px var(--red);
  display: block;
}

.hero-h1 .line3 {
  color: var(--red);
  display: block;
}

.hero-body {
  max-width: 480px;
  font-size: 0.95rem;
  line-height: 2;
  color: #dddddd;
  font-weight: 300;
  margin-bottom: 3rem;
  animation: fade-in 0.8s 0.2s ease both;
  text-shadow: 0 1px 8px rgba(0,0,0,0.9);
}

.hero-actions {
  display: flex;
  gap: 1px;
  animation: fade-in 0.8s 0.3s ease both;
}

.btn-white {
  background: var(--white);
  color: var(--black);
  border: none;
  padding: 1rem 2.5rem;
  font-family: 'IBM Plex Mono', monospace;
  font-size: 0.75rem;
  letter-spacing: 0.2em;
  text-transform: uppercase;
  text-decoration: none;
  display: inline-flex;
  align-items: center;
  gap: 0.7rem;
  transition: all 0.2s;
}

.btn-white:hover { background: var(--red); color: var(--white); }

.btn-outline {
  background: transparent;
  color: #dddddd;
  border: 1px solid #dddddd;
  padding: 1rem 2.5rem;
  font-family: 'IBM Plex Mono', monospace;
  font-size: 0.75rem;
  letter-spacing: 0.2em;
  text-transform: uppercase;
  text-decoration: none;
  display: inline-flex;
  align-items: center;
  transition: all 0.2s;
}

.btn-outline:hover { border-color: var(--white); color: var(--white); }

.hero-scroll {
  display: none;
}

/* WORKS SECTION */
.works-section {
  padding: 4rem;
  background: var(--black);
}

.section-head {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 2rem;
  padding-bottom: 1.5rem;
  border-bottom: 1px solid var(--border);
}

.section-title {
  font-family: 'Bebas Neue', sans-serif;
  font-size: 2rem;
  letter-spacing: 0.15em;
  color: var(--white);
}

.filters {
  display: flex;
  gap: 0;
}

.filter-btn {
  background: none;
  border: 1px solid var(--border);
  color: #888888;
  padding: 0.5rem 1.2rem;
  font-family: 'IBM Plex Mono', monospace;
  font-size: 0.65rem;
  letter-spacing: 0.15em;
  text-transform: uppercase;
  transition: all 0.2s;
  margin-left: -1px;
}

.filter-btn:hover, .filter-btn.active {
  background: var(--black);
  color: var(--white);
  border-color: var(--white);
  z-index: 1;
}

.works-list {
  display: flex;
  flex-direction: column;
  max-height: 72vh;
  overflow-y: auto;
  overflow-x: visible;
  scrollbar-width: thin;
  scrollbar-color: var(--border) transparent;
}

.works-list::-webkit-scrollbar { width: 4px; }
.works-list::-webkit-scrollbar-track { background: transparent; }
.works-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
.works-list::-webkit-scrollbar-thumb:hover { background: var(--muted); }

.work-card {
  display: grid;
  grid-template-columns: 200px 1fr 160px;
  border: 1px solid var(--border);
  margin-bottom: -1px;
  transition: all 0.25s;
  position: relative;
  animation: fade-in 0.5s ease both;
  cursor: pointer;
}

.work-card::before { display: none; }

.work-card:hover { border-color: var(--red); z-index: 1; }

.work-card > * { position: relative; z-index: 1; }

.work-left {
  padding: 2rem;
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  background: #0a0a0a;
  transition: background 0.25s, border-color 0.25s;
}

.work-card:hover .work-left {
  background: var(--red);
  border-right-color: var(--red);
}

.work-num {
  font-family: 'Bebas Neue', sans-serif;
  font-size: 4rem;
  line-height: 1;
  color: var(--border);
  transition: color 0.25s;
}

.work-card:hover .work-num { color: var(--white); }

.work-format-badge {
  display: inline-block;
  font-family: 'IBM Plex Mono', monospace;
  font-size: 0.6rem;
  letter-spacing: 0.2em;
  text-transform: uppercase;
  padding: 0.3rem 0.7rem;
  border: 1px solid;
  transition: all 0.25s;
}

.work-format-badge.manga { border-color: var(--red); color: var(--red); }
.work-format-badge.novel { border-color: #4488ff; color: #4488ff; }
.work-card:hover .work-format-badge { border-color: var(--white); color: var(--white); }

.work-mid {
  padding: 2rem 2.5rem;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  gap: 1rem;
  background: #0d0d0d;
  transition: background 0.25s;
}

.work-card:hover .work-mid { background: #1a0000; }

.work-genre {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 0.6rem;
  letter-spacing: 0.2em;
  color: #777777;
  text-transform: uppercase;
  transition: color 0.25s;
}

.work-card:hover .work-genre { color: #ff8888; }

.work-title {
  font-family: 'Noto Serif JP', serif;
  font-size: 1.3rem;
  font-weight: 700;
  line-height: 1.4;
  letter-spacing: 0.02em;
  color: var(--white);
}

.work-synopsis {
  font-size: 0.8rem;
  line-height: 1.9;
  color: #aaaaaa;
  font-weight: 300;
  display: -webkit-box;
  -webkit-line-clamp: 3;
  -webkit-box-orient: vertical;
  overflow: hidden;
  transition: color 0.25s;
}

.work-card:hover .work-synopsis { color: #dddddd; }

.work-bottom-row {
  display: flex;
  align-items: center;
  gap: 2rem;
}

.work-meta {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 0.6rem;
  color: #777777;
  letter-spacing: 0.1em;
  transition: color 0.25s;
}

.work-card:hover .work-meta { color: #ff8888; }

.work-right {
  border-left: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 2rem;
  gap: 1.5rem;
  background: #0a0a0a;
  transition: background 0.25s, border-color 0.25s;
}

.work-card:hover .work-right {
  background: #1a0000;
  border-left-color: var(--red);
}

.work-price {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.4rem;
  width: 100%;
}

.work-price-num {
  font-family: 'Bebas Neue', sans-serif;
  font-size: 2.2rem;
  letter-spacing: 0.05em;
  color: var(--white);
  display: block;
  line-height: 1;
}

.work-price-label {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 0.55rem;
  color: var(--muted);
  letter-spacing: 0.08em;
  white-space: nowrap;
  display: block;
}

.btn-card {
  width: 100%;
  background: transparent;
  color: var(--white);
  border: 1px solid var(--border);
  padding: 0.7rem;
  font-family: 'IBM Plex Mono', monospace;
  font-size: 0.6rem;
  letter-spacing: 0.2em;
  text-transform: uppercase;
  transition: all 0.2s;
}

.btn-card:hover, .btn-card.primary {
  background: var(--white);
  color: var(--black);
  border-color: var(--white);
}

.btn-card.primary:hover { background: var(--red); border-color: var(--red); color: var(--white); }

/* MODAL */
.overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.9);
  z-index: 500;
  align-items: center;
  justify-content: center;
  padding: 2rem;
  backdrop-filter: blur(4px);
}

.overlay.open { display: flex; }

.modal {
  background: var(--black);
  border: 1px solid var(--border);
  max-width: 640px;
  width: 100%;
  max-height: 90vh;
  overflow-y: auto;
  position: relative;
}

.modal-top-bar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 1.2rem 2rem;
  border-bottom: 1px solid var(--border);
  background: var(--dim);
}

.modal-label {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 0.65rem;
  letter-spacing: 0.3em;
  color: #aaa;
  text-transform: uppercase;
}

.modal-close {
  background: none;
  border: 1px solid #aaa;
  color: #aaa;
  width: 28px; height: 28px;
  font-family: 'IBM Plex Mono', monospace;
  font-size: 0.8rem;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}

.modal-close:hover { background: var(--red); border-color: var(--red); color: var(--white); }

.modal-content { padding: 2rem; }

.modal-title {
  font-family: 'Noto Serif JP', serif;
  font-size: 1.6rem;
  font-weight: 700;
  margin-bottom: 0.5rem;
  line-height: 1.3;
}

.modal-badges { display: flex; gap: 0.5rem; margin-bottom: 2rem; margin-top: 0.8rem; }

.modal-synopsis-box {
  background: var(--dim);
  border-left: 2px solid var(--red);
  padding: 1.5rem;
  font-size: 0.85rem;
  line-height: 2;
  color: #cccccc;
  font-weight: 300;
  margin-bottom: 2rem;
}

.modal-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  border: 1px solid var(--border);
  margin-bottom: 2rem;
}

.modal-grid-item {
  padding: 1.2rem 1.5rem;
  border-right: 1px solid var(--border);
  border-bottom: 1px solid var(--border);
}

.modal-grid-item:nth-child(2n) { border-right: none; }
.modal-grid-item:nth-last-child(-n+2) { border-bottom: none; }

.mgrid-label {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 0.55rem;
  letter-spacing: 0.25em;
  color: var(--muted);
  text-transform: uppercase;
  display: block;
  margin-bottom: 0.4rem;
}

.mgrid-val {
  font-size: 0.9rem;
  font-weight: 400;
  color: var(--white);
}

.modal-acquire-bar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  border: 1px solid var(--border);
  padding: 1.5rem 2rem;
  background: var(--dim);
  gap: 2rem;
}

.modal-price-big {
  font-family: 'Bebas Neue', sans-serif;
  font-size: 3rem;
  line-height: 1;
  color: var(--white);
}

.modal-price-sub {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 0.6rem;
  color: var(--muted);
  letter-spacing: 0.1em;
  margin-top: 0.3rem;
}

.btn-acquire-main {
  background: var(--white);
  color: var(--black);
  border: none;
  padding: 1rem 2rem;
  font-family: 'IBM Plex Mono', monospace;
  font-size: 0.75rem;
  letter-spacing: 0.2em;
  text-transform: uppercase;
  white-space: nowrap;
  transition: all 0.2s;
  flex-shrink: 0;
}

.btn-acquire-main:hover { background: var(--red); color: var(--white); }

/* FORM */
.form-block { margin-bottom: 1.5rem; }

.form-lbl {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 0.6rem;
  letter-spacing: 0.25em;
  text-transform: uppercase;
  color: #aaa;
  display: block;
  margin-bottom: 0.6rem;
}

.form-lbl .req {
  color: var(--red);
  margin-left: 0.2em;
}

.form-ctrl {
  width: 100%;
  background: var(--dim);
  border: 1px solid var(--border);
  color: var(--white);
  padding: 0.9rem 1rem;
  font-family: 'Noto Serif JP', serif;
  font-size: 0.9rem;
  outline: none;
  transition: border-color 0.2s;
  -webkit-appearance: none;
}

.form-ctrl::placeholder { color: #555; }
.form-ctrl:focus { border-color: var(--white); }

textarea.form-ctrl { resize: vertical; min-height: 130px; line-height: 1.8; }

.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }

.btn-submit {
  width: 100%;
  background: var(--white);
  color: var(--black);
  border: none;
  padding: 1.1rem;
  font-family: 'IBM Plex Mono', monospace;
  font-size: 0.75rem;
  letter-spacing: 0.3em;
  text-transform: uppercase;
  transition: all 0.2s;
  margin-top: 0.5rem;
}

.btn-submit:hover { background: var(--red); color: var(--white); }

/* TOAST */
.toast {
  position: fixed;
  bottom: 2.5rem;
  left: 50%;
  transform: translateX(-50%) translateY(80px);
  background: var(--white);
  color: var(--black);
  padding: 1rem 2rem;
  font-family: 'IBM Plex Mono', monospace;
  font-size: 0.75rem;
  letter-spacing: 0.1em;
  z-index: 1000;
  opacity: 0;
  transition: all 0.3s ease;
  white-space: nowrap;
}

.toast.show {
  opacity: 1;
  transform: translateX(-50%) translateY(0);
}

/* EMPTY */
.empty-state {
  padding: 5rem 2rem;
  text-align: center;
  border: 1px solid var(--border);
  color: var(--muted);
}

.empty-state p {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 0.7rem;
  letter-spacing: 0.2em;
  text-transform: uppercase;
}

/* ANIMATIONS */
@keyframes fade-in {
  from { opacity: 0; transform: translateY(16px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes blink-orange {
  0%, 100% { opacity: 1; }
  50% { opacity: 0; }
}

.new-badge {
  display: inline-block;
  font-family: 'IBM Plex Mono', monospace;
  font-size: 0.5rem;
  font-weight: 700;
  letter-spacing: 0.15em;
  color: #ff6600;
  background: rgba(255,102,0,0.12);
  border: 1px solid #ff6600;
  padding: 0.1rem 0.4rem;
  margin-left: 0.5rem;
  vertical-align: middle;
  animation: blink-orange 1.2s ease-in-out infinite;
}

.ep-badge {
  display: inline-block;
  font-family: 'IBM Plex Mono', monospace;
  font-size: 0.5rem;
  letter-spacing: 0.1em;
  color: #aaa;
  border: 1px solid #333;
  padding: 0.1rem 0.4rem;
  margin-left: 0.4rem;
  vertical-align: middle;
}

/* 概要ウィンドウ話数リスト */
.ep-list {
  display: flex;
  flex-direction: column;
  gap: 1px;
  margin-top: 1.5rem;
  border-top: 1px solid var(--border);
  padding-top: 1rem;
}

.ep-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0.7rem 0.8rem;
  border: 1px solid #222;
  background: #0a0a0a;
  gap: 1rem;
  transition: border-color 0.2s;
}

.ep-row:hover { border-color: #aaa; }

.ep-row-info { flex: 1; min-width: 0; }

.ep-row-num {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 0.55rem;
  color: #aaa;
  letter-spacing: 0.1em;
  margin-bottom: 0.2rem;
}

.ep-row-author {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 0.5rem;
  color: #444;
  letter-spacing: 0.05em;
  margin-top: 0.15rem;
}

.ep-row-read {
  background: none;
  border: 1px solid #444;
  color: #aaa;
  font-family: 'IBM Plex Mono', monospace;
  font-size: 0.55rem;
  letter-spacing: 0.08em;
  padding: 0.35rem 0.8rem;
  cursor: pointer;
  transition: all 0.2s;
  white-space: nowrap;
  flex-shrink: 0;
}

.ep-row-read:hover { border-color: #fff; color: #fff; }

/* SCROLLBAR */
::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: var(--black); }
::-webkit-scrollbar-thumb { background: var(--border); }
::-webkit-scrollbar-thumb:hover { background: var(--muted); }

.work-reactions {
  display: flex;
  align-items: center;
  gap: 1rem;
  margin-left: auto;
}

.reaction-item {
  display: flex;
  align-items: center;
  gap: 0.3rem;
  cursor: pointer;
}

.reaction-icon {
  display: flex;
  align-items: center;
  line-height: 1;
  color: #777777;
  transition: transform 0.15s, color 0.2s;
}

.reaction-item:hover .reaction-icon { transform: scale(1.2); color: var(--white); }

.reaction-count {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 0.6rem;
  color: #777777;
  transition: color 0.2s;
}

.reaction-item:hover .reaction-count { color: var(--white); }

.author-link {
  text-decoration: underline;
  text-decoration-color: #444;
  transition: color 0.2s;
}
.author-link:hover { color: var(--white) !important; text-decoration-color: var(--white); }

.prof-work-item {
  display: flex;
  align-items: center;
  gap: 0.8rem;
  padding: 0.8rem 1rem;
  border: 1px solid #222;
  background: #0a0a0a;
  transition: border-color 0.2s;
  cursor: pointer;
}
.prof-work-item:hover { border-color: var(--white); }
.prof-work-title {
  font-size: 0.85rem;
  flex: 1;
  color: var(--white);
}
.prof-work-status {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 0.6rem;
  letter-spacing: 0.1em;
  color: #4488ff;
}
.prof-work-status.sold { color: #aaa; }

/* READER PAGE */
.reader-page-wrap {
  display: none;
  position: fixed;
  inset: 0;
  background: #f9f6f1;
  z-index: 200;
  flex-direction: column;
  overflow-y: auto;
}

.reader-page-wrap.open { display: flex; }

.reader-page-header {
  position: sticky;
  top: 0;
  background: #f9f6f1;
  border-bottom: 1px solid #ddd;
  padding: 0.8rem 2rem;
  display: flex;
  align-items: center;
  z-index: 10;
}

.reader-page-title {
  font-family: 'Noto Serif JP', serif;
  font-size: 0.9rem;
  color: #333;
  letter-spacing: 0.05em;
}

.reader-back-btn {
  background: none;
  border: 1px solid #ccc;
  color: #aaa;
  font-family: 'IBM Plex Mono', monospace;
  font-size: 0.6rem;
  letter-spacing: 0.15em;
  padding: 0.4rem 1rem;
  transition: all 0.2s;
}

.reader-back-btn:hover { border-color: #333; color: #333; }

.reader-content {
  max-width: 640px;
  margin: 0 auto;
  padding: 4rem 2rem 8rem;
  width: 100%;
}

.reader-content h1 {
  font-family: 'Noto Serif JP', serif;
  font-size: 1.8rem;
  font-weight: 700;
  color: #111;
  margin-bottom: 0.5rem;
  line-height: 1.4;
}

.reader-content .reader-meta {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 0.65rem;
  color: #aaa;
  letter-spacing: 0.1em;
  margin-bottom: 3rem;
  padding-bottom: 1.5rem;
  border-bottom: 1px solid #ddd;
}

.reader-paragraph {
  font-family: 'Noto Serif JP', serif;
  font-size: 1rem;
  line-height: 2.2;
  color: #222;
  margin-bottom: 1.8rem;
}

/* READER */

.nav-user-wrap {
  position: relative;
  display: flex;
  align-items: stretch;
}

.nav-dropdown {
  display: none;
  position: absolute;
  top: 100%;
  right: 0;
  background: var(--black);
  border: 1px solid var(--border);
  min-width: 160px;
  z-index: 200;
  flex-direction: column;
}

.nav-dropdown.open { display: flex; }

.nav-dropdown button {
  background: none;
  border: none;
  border-bottom: 1px solid var(--border);
  color: #aaa;
  font-family: 'IBM Plex Mono', monospace;
  font-size: 0.6rem;
  letter-spacing: 0.1em;
  padding: 0.9rem 1.2rem;
  text-align: left;
  transition: all 0.2s;
  cursor: crosshair;
}

.nav-dropdown button:last-child { border-bottom: none; }
.nav-dropdown button:hover { background: var(--dim); color: var(--white); }

footer {
  border-top: 1px solid var(--border);
  padding: 2rem 4rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.footer-logo {
  font-family: 'Bebas Neue', sans-serif;
  font-size: 1.2rem;
  letter-spacing: 0.3em;
  color: var(--muted);
}

.footer-note {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 0.6rem;
  color: var(--border);
  letter-spacing: 0.1em;
}

@media (max-width: 768px) {
  .hero { padding: 4rem 1.5rem; padding-top: calc(56px + 2rem); }
  .hero-bg-text { display: none; }
  .works-section { padding: 2rem 1.5rem; }
  .work-card { grid-template-columns: 1fr; }
  .work-left { flex-direction: row; align-items: center; padding: 1rem 1.5rem; border-right: none; border-bottom: 1px solid var(--border); }
  .work-right { border-left: none; border-top: 1px solid var(--border); flex-direction: row; padding: 1rem 1.5rem; }
  .stats { grid-template-columns: 1fr 1fr; }
  .modal-acquire-bar { flex-direction: column; align-items: flex-start; }
  .form-row { grid-template-columns: 1fr; }
  footer { padding: 1.5rem; flex-direction: column; gap: 0.5rem; text-align: center; }
}
</style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<!-- ローディング画面 -->
<div id="loading-screen" style="position:fixed;inset:0;background:#0a0a0a;z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:1.5rem;">
  <div style="font-family:'Bebas Neue',sans-serif;font-size:2rem;letter-spacing:0.3em;color:#fff;">BLACK BOX</div>
  <div style="width:40px;height:2px;background:var(--border);position:relative;overflow:hidden;">
    <div style="position:absolute;inset:0;background:#fff;animation:loading-bar 1.2s ease-in-out infinite;transform:translateX(-100%);"></div>
  </div>
</div>
<style>
@keyframes loading-bar {
  0% { transform: translateX(-100%); }
  100% { transform: translateX(100%); }
}
</style>

<header>
  <a class="logo-wrap" href="#">
    <div class="logo-box"><div class="logo-box-inner"></div></div>
    <span class="logo-text">BLACK BOX</span>
  </a>
  <nav>
    <a href="#works" class="active" onclick="setFilter('all'); return false;">すべて</a>
    <a href="#" onclick="setFilter('manga'); return false;">漫画</a>
    <a href="#" onclick="setFilter('novel'); return false;">小説</a>
    <div class="nav-user-wrap" id="nav-user-wrap">
      <a href="#" id="nav-auth-btn" class="nav-post" onclick="handleAuthClick(event)">ログイン</a>
      <div class="nav-dropdown" id="nav-dropdown">
        <button onclick="goToMyProfile()">マイプロフィール</button>
        <button onclick="openSettings()">アカウント設定</button>
        <button onclick="doLogout()">ログアウト</button>
      </div>
    </div>
  </nav>
</header>

<!-- HERO -->
<section class="hero" id="top">
  <div class="hero-bg-text">BB</div>
  <div class="hero-eyebrow">未完作品の完全譲渡市場</div>
  <h1 class="hero-h1">
    描いた。
    <span class="line2">続きは</span>
    <span class="line3">あなたへ。</span>
  </h1>
  <p class="hero-body">
    0→1を作れるが続けられない作家と、1→100を描けるが始められない作家をつなぐ。
    作品の権利を完全譲渡し、次のページを誰かに委ねる場所。
  </p>
  <div class="hero-actions">
    <a href="#works" class="btn-white">
      <span>作品を見る</span>
      <span>↓</span>
    </a>
    <a href="#" class="btn-outline" onclick="openPost(); return false;">新規投稿</a>
  </div>
  <div class="hero-scroll"></div>
</section>

<!-- WORKS -->
<section class="works-section" id="works">
  <div class="section-head">
    <h2 class="section-title">掲載中の作品</h2>
  </div>
  <div class="works-list" id="works-list"></div>
</section>

<footer>
  <span class="footer-logo">BLACK BOX</span>
  <span class="footer-note">試作版 v0.1 — 未完作品の完全譲渡市場</span>
  <div style="margin-top:1rem;display:flex;gap:1.5rem;justify-content:center;flex-wrap:wrap;">
    <a href="#" onclick="openLegal('terms'); return false;" style="font-family:'IBM Plex Mono',monospace;font-size:0.55rem;color:#aaa;letter-spacing:0.1em;text-decoration:none;">利用規約</a>
    <a href="#" onclick="openLegal('privacy'); return false;" style="font-family:'IBM Plex Mono',monospace;font-size:0.55rem;color:#aaa;letter-spacing:0.1em;text-decoration:none;">プライバシーポリシー</a>
  </div>
</footer>

<!-- CONFIRM DIALOG -->
<div class="overlay" id="confirm-overlay" style="z-index:10000;">
  <div class="modal" style="max-width:420px;">
    <div class="modal-content" style="padding:2rem;">
      <div id="confirm-title" style="font-family:'Noto Serif JP',serif;font-size:1.1rem;font-weight:700;margin-bottom:1rem;"></div>
      <div id="confirm-message" style="font-family:'IBM Plex Mono',monospace;font-size:0.65rem;color:#aaa;line-height:2;letter-spacing:0.05em;margin-bottom:2rem;"></div>
      <div style="display:flex;gap:0.75rem;justify-content:flex-end;">
        <button id="confirm-cancel-btn" style="background:none;border:1px solid var(--border);color:#aaa;padding:0.7rem 1.5rem;font-family:'IBM Plex Mono',monospace;font-size:0.6rem;letter-spacing:0.15em;cursor:pointer;">キャンセル</button>
        <button id="confirm-ok-btn" style="background:var(--white);color:var(--black);border:none;padding:0.7rem 1.5rem;font-family:'IBM Plex Mono',monospace;font-size:0.6rem;letter-spacing:0.15em;cursor:pointer;"></button>
      </div>
    </div>
  </div>
</div>

<!-- LEGAL MODAL -->
<div class="overlay" id="legal-overlay">
  <div class="modal" style="max-width:680px;">
    <div class="modal-top-bar">
      <span class="modal-label" id="legal-title">利用規約</span>
      <button class="modal-close" onclick="closeOverlay('legal-overlay')">✕</button>
    </div>
    <div class="modal-content" id="legal-body" style="font-size:0.85rem;line-height:2;color:#ccc;max-height:70vh;overflow-y:auto;"></div>
  </div>
</div>
<div class="overlay" id="detail-overlay">
  <div class="modal">
    <div class="modal-top-bar">
      <span class="modal-label">作品詳細</span>
      <button class="modal-close" onclick="closeOverlay('detail-overlay')">✕</button>
    </div>
    <div class="modal-content">
      <div class="modal-badges" id="d-badges"></div>
      <div class="modal-title" id="d-title"></div>
      <div class="modal-synopsis-box" id="d-synopsis"></div>
      <div class="modal-grid">
        <div class="modal-grid-item">
          <span class="mgrid-label">ジャンル</span>
          <span class="mgrid-val" id="d-genre"></span>
        </div>
        <div class="modal-grid-item">
          <span class="mgrid-label">作者</span>
          <span class="mgrid-val" id="d-author"></span>
        </div>
        <div class="modal-grid-item">
          <span class="mgrid-label">形式</span>
          <span class="mgrid-val" id="d-format"></span>
        </div>
        <div class="modal-grid-item">
          <span class="mgrid-label">投稿日</span>
          <span class="mgrid-val" id="d-date"></span>
        </div>
      </div>
      <div class="modal-acquire-bar">
        <div style="display:none;">
          <div class="modal-price-big" id="d-price"></div>
          <div class="modal-price-sub">完全譲渡 — 続編・商用利用・再販すべて可</div>
        </div>
        <div style="font-family:'IBM Plex Mono',monospace;font-size:0.55rem;color:#aaa;letter-spacing:0.05em;line-height:1.8;">続編・商用利用・再販すべて可<br>（テスト版のため無料で譲渡）</div>
        <div style="display:flex;flex-direction:column;gap:0.5rem;align-items:flex-end;">
          <button class="btn-acquire-main" id="d-read-btn" style="display:none;background:#222;color:#fff;border:1px solid #444;" onclick="openReaderFromDetail()">本文を読む →</button>
          <button class="btn-acquire-main" id="d-acquire-btn" onclick="acquireWork()">続きを書く →</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- POST MODAL -->
<div class="overlay" id="post-overlay">
  <div class="modal">
    <div class="modal-top-bar">
      <span class="modal-label" id="f-modal-label">新規投稿</span>
      <button class="modal-close" onclick="closePost()">✕</button>
    </div>
    <div class="modal-content">

      <!-- 続編モード：固定情報表示 -->
      <div id="f-sequel-info" style="display:none;background:#111;border:1px solid #333;padding:1rem 1.2rem;margin-bottom:1.5rem;">
        <div style="font-family:'IBM Plex Mono',monospace;font-size:0.55rem;color:#aaa;letter-spacing:0.15em;margin-bottom:0.6rem;">前話から引き継がれる情報（変更不可）</div>
        <div style="display:flex;align-items:center;gap:0.75rem;flex-wrap:wrap;">
          <span id="f-sequel-format-badge" class="work-format-badge"></span>
          <span id="f-sequel-title" style="font-family:'Noto Serif JP',serif;font-size:1rem;font-weight:700;"></span>
          <span id="f-sequel-genre" style="font-family:'IBM Plex Mono',monospace;font-size:0.6rem;color:#aaa;"></span>
        </div>
      </div>

      <!-- 通常モード：タイトル・形式・ジャンル -->
      <div id="f-normal-fields">
        <div class="form-block">
          <label class="form-lbl">タイトル <span class="req">*</span> <span id="f-title-count" style="float:right;color:#aaa;">0/40</span></label>
          <input type="text" class="form-ctrl" id="f-title" placeholder="作品タイトル" maxlength="40" oninput="document.getElementById('f-title-count').textContent=this.value.length+'/40'">
        </div>
        <div class="form-row">
          <div class="form-block">
            <label class="form-lbl">形式 <span class="req">*</span></label>
            <select class="form-ctrl" id="f-format">
              <option value="manga">漫画</option>
              <option value="novel">小説</option>
            </select>
          </div>
          <div class="form-block">
            <label class="form-lbl">ジャンル</label>
            <input type="text" class="form-ctrl" id="f-genre" placeholder="SF、ホラー、恋愛…">
          </div>
        </div>
      </div>
      <div class="form-block">
        <label class="form-lbl">あらすじ <span class="req">*</span> <span id="f-synopsis-count" style="float:right;color:#aaa;">0/160</span></label>
        <textarea class="form-ctrl" id="f-synopsis" placeholder="どんな話か、どこで止まっているかを書いてください" maxlength="160" oninput="document.getElementById('f-synopsis-count').textContent=this.value.length+'/160'"></textarea>
      </div>
      <div class="form-block" id="f-manga-block" style="display:none;">
        <label class="form-lbl">漫画原稿（画像ファイル、複数選択可）</label>
        <input type="file" id="f-manga-files" accept="image/*" multiple style="width:100%;background:#0d0d0d;border:1px solid var(--border);color:#ddd;padding:0.8rem;font-family:'IBM Plex Mono',monospace;font-size:0.65rem;cursor:pointer;">
        <div id="f-manga-preview" style="display:flex;flex-wrap:wrap;gap:0.5rem;margin-top:0.75rem;"></div>
        <div id="f-manga-hint" style="display:none;font-family:'IBM Plex Mono',monospace;font-size:0.5rem;color:#aaa;letter-spacing:0.1em;margin-top:0.5rem;">ドラッグで順番入れ替え・×で削除</div>
      </div>
      <div class="form-block" id="f-novel-block" style="display:none;">
        <label class="form-lbl">本文（段落ごとに空行で区切ってください）</label>
        <textarea class="form-ctrl" id="f-body" placeholder="ここに本文を入力..." style="min-height:240px;line-height:2;font-family:'Noto Serif JP',serif;font-size:0.85rem;resize:vertical;"></textarea>
      </div>
      <div class="form-block">
        <label class="form-lbl">譲渡価格（¥）</label>
        <input type="hidden" id="f-price" value="0">
        <div style="background:var(--dim);border:1px solid var(--border);padding:0.9rem 1rem;font-family:'IBM Plex Mono',monospace;font-size:0.6rem;color:#555;letter-spacing:0.1em;">テスト版のため設定できません</div>
      </div>
      <div style="display:flex;gap:0.75rem;margin-top:0.5rem;flex-wrap:wrap;">
        <button class="btn-submit" id="f-submit-btn" onclick="submitWork()" style="flex:1;min-width:120px;">投稿する →</button>
        <button onclick="saveDraft()" style="background:none;border:1px solid var(--border);color:#aaa;padding:0.8rem 1.5rem;font-family:'IBM Plex Mono',monospace;font-size:0.7rem;letter-spacing:0.15em;cursor:pointer;transition:all 0.2s;white-space:nowrap;" onmouseover="this.style.borderColor='#fff';this.style.color='#fff'" onmouseout="this.style.borderColor='var(--border)';this.style.color='#aaa'">下書き保存</button>
        <button onclick="openPreviewFromForm()" style="background:none;border:1px solid var(--border);color:#aaa;padding:0.8rem 1.5rem;font-family:'IBM Plex Mono',monospace;font-size:0.7rem;letter-spacing:0.15em;cursor:pointer;transition:all 0.2s;white-space:nowrap;" onmouseover="this.style.borderColor='#fff';this.style.color='#fff'" onmouseout="this.style.borderColor='var(--border)';this.style.color='#aaa'">プレビュー</button>
      </div>
      <!-- ローディング -->
      <div id="f-loading" style="display:none;margin-top:1rem;font-family:'IBM Plex Mono',monospace;font-size:0.6rem;color:#aaa;letter-spacing:0.15em;text-align:center;">
        <div id="f-loading-text">アップロード中...</div>
        <div id="f-loading-bar" style="margin-top:0.5rem;height:2px;background:#333;position:relative;overflow:hidden;">
          <div id="f-loading-progress" style="position:absolute;left:0;top:0;height:100%;background:var(--red);width:0%;transition:width 0.3s;"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- SETTINGS MODAL -->
<div class="overlay" id="settings-overlay">
  <div class="modal">
    <div class="modal-top-bar">
      <span class="modal-label">アカウント設定</span>
      <button class="modal-close" onclick="closeOverlay('settings-overlay')">✕</button>
    </div>

    <!-- タブ -->
    <div style="display:flex;border-bottom:1px solid var(--border);">
      <button onclick="switchSettingsTab('profile')" id="settings-tab-profile" style="flex:1;padding:0.8rem;background:#111;border:none;border-bottom:2px solid var(--white);color:var(--white);font-family:'IBM Plex Mono',monospace;font-size:0.6rem;letter-spacing:0.15em;cursor:pointer;">プロフィール</button>
      <button onclick="switchSettingsTab('account')" id="settings-tab-account" style="flex:1;padding:0.8rem;background:#111;border:none;border-bottom:2px solid transparent;color:#555;font-family:'IBM Plex Mono',monospace;font-size:0.6rem;letter-spacing:0.15em;cursor:pointer;">アカウント</button>
      <button onclick="switchSettingsTab('danger')" id="settings-tab-danger" style="flex:1;padding:0.8rem;background:#111;border:none;border-bottom:2px solid transparent;color:#555;font-family:'IBM Plex Mono',monospace;font-size:0.6rem;letter-spacing:0.15em;cursor:pointer;">退会</button>
    </div>

    <!-- プロフィールタブ -->
    <div id="settings-content-profile" class="modal-content">
      <div class="form-block" style="display:flex;align-items:center;gap:1.5rem;margin-bottom:1.5rem;">
        <div id="s-avatar-preview" style="width:64px;height:64px;border-radius:50%;background:#222;border:1px solid #333;overflow:hidden;flex-shrink:0;display:flex;align-items:center;justify-content:center;">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#aaa" stroke-width="1.5"><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 3.6-7 8-7s8 3 8 7"/></svg>
        </div>
        <div>
          <label class="form-lbl">プロフィール画像</label>
          <div style="display:flex;gap:0.5rem;flex-wrap:wrap;">
            <input type="file" id="s-avatar-file" accept="image/*" style="display:none;" onchange="previewAvatar(this)">
            <button onclick="document.getElementById('s-avatar-file').click()" style="background:none;border:1px solid var(--border);color:#aaa;padding:0.4rem 1rem;font-family:'IBM Plex Mono',monospace;font-size:0.6rem;letter-spacing:0.1em;cursor:pointer;">画像を選択</button>
            <button id="s-avatar-delete-btn" onclick="deleteAvatar()" style="display:none;background:none;border:1px solid #662222;color:#aa4444;padding:0.4rem 1rem;font-family:'IBM Plex Mono',monospace;font-size:0.6rem;letter-spacing:0.1em;cursor:pointer;">削除</button>
          </div>
        </div>
      </div>
      <div class="form-block">
        <label class="form-lbl">ペンネーム</label>
        <input type="text" class="form-ctrl" id="s-name" placeholder="名前">
      </div>
      <div class="form-block">
        <label class="form-lbl">自己紹介</label>
        <textarea class="form-ctrl" id="s-bio" placeholder="一言プロフィール" style="height:100px;"></textarea>
      </div>
      <button class="btn-submit" onclick="saveSettings()">保存する →</button>
    </div>

    <!-- アカウントタブ -->
    <div id="settings-content-account" class="modal-content" style="display:none;">
      <div class="form-block">
        <label class="form-lbl">メールアドレス</label>
        <input type="email" class="form-ctrl" id="s-email" placeholder="new@email.com">
        <div style="margin-top:0.75rem;">
          <button class="btn-submit" onclick="updateEmail()" style="width:100%;">メールアドレスを変更 →</button>
        </div>
      </div>
      <div class="form-block" style="margin-top:1.5rem;padding-top:1.5rem;border-top:1px solid var(--border);">
        <label class="form-lbl">パスワード変更</label>
        <div style="font-family:'IBM Plex Mono',monospace;font-size:0.55rem;color:#aaa;line-height:2;letter-spacing:0.05em;margin-bottom:0.75rem;">
          登録中のメールアドレスにパスワード変更リンクを送信します
        </div>
        <button class="btn-submit" onclick="sendPasswordReset()" style="width:100%;">変更リンクを送信 →</button>
      </div>
    </div>

    <!-- 退会タブ -->
    <div id="settings-content-danger" class="modal-content" style="display:none;">
      <div style="font-family:'IBM Plex Mono',monospace;font-size:0.65rem;color:#aaa;line-height:2;letter-spacing:0.05em;margin-bottom:2rem;">
        退会すると以下の処理が行われます。<br>
        ・ログインできなくなります<br>
        ・譲渡済みの作品はそのまま残ります<br>
        ・未譲渡の作品は非公開になります<br>
        ・この操作は取り消せません
      </div>
      <button onclick="confirmWithdrawal()" style="width:100%;background:none;border:1px solid #662222;color:#aa4444;padding:1rem;font-family:'IBM Plex Mono',monospace;font-size:0.7rem;letter-spacing:0.2em;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.background='#1a0000'" onmouseout="this.style.background='none'">退会手続きをする</button>
    </div>

  </div>
</div>

<!-- LOGIN MODAL -->
<div class="overlay" id="login-overlay">
  <div class="modal">
    <div class="modal-top-bar">
      <span class="modal-label" id="login-modal-label">ログイン</span>
      <button class="modal-close" onclick="closeOverlay('login-overlay')">✕</button>
    </div>
    <div class="modal-content">
      <div id="login-form">
        <div class="form-block">
          <label class="form-lbl">メールアドレス</label>
          <input type="email" class="form-ctrl" id="login-email" placeholder="your@email.com">
        </div>
        <div class="form-block">
          <label class="form-lbl">パスワード</label>
          <input type="password" class="form-ctrl" id="login-password" placeholder="••••••••">
        </div>
        <button class="btn-submit" onclick="doLogin()">ログイン →</button>
        <div style="margin-top:1rem;text-align:center;">
          <button onclick="switchToSignup()" style="background:none;border:none;color:#aaa;font-family:'IBM Plex Mono',monospace;font-size:0.6rem;letter-spacing:0.1em;cursor:pointer;text-decoration:underline;">アカウントを作成する</button>
        </div>
      </div>
      <div id="signup-form" style="display:none;">
        <div class="form-block">
          <label class="form-lbl">ペンネーム <span class="req">*</span></label>
          <input type="text" class="form-ctrl" id="signup-name" placeholder="表示名">
        </div>
        <div class="form-block">
          <label class="form-lbl">メールアドレス <span class="req">*</span></label>
          <input type="email" class="form-ctrl" id="signup-email" placeholder="your@email.com">
        </div>
        <div class="form-block">
          <label class="form-lbl">パスワード <span class="req">*</span></label>
          <input type="password" class="form-ctrl" id="signup-password" placeholder="6文字以上">
        </div>
        <button class="btn-submit" onclick="doSignup()">アカウント作成 →</button>
        <div style="margin-top:1rem;text-align:center;">
          <button onclick="switchToLogin()" style="background:none;border:none;color:#aaa;font-family:'IBM Plex Mono',monospace;font-size:0.6rem;letter-spacing:0.1em;cursor:pointer;text-decoration:underline;">ログインに戻る</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- PROFILE MODAL -->
<div class="overlay" id="profile-overlay">
  <div class="modal" style="max-width:680px;">
    <div class="modal-top-bar">
      <span class="modal-label" id="prof-modal-label">プロフィール</span>
      <button class="modal-close" onclick="closeOverlay('profile-overlay')">✕</button>
    </div>

    <!-- タブ（本人のみ管理タブ表示） -->
    <div id="prof-tabs" style="display:none;border-bottom:1px solid var(--border);display:flex;">
      <button onclick="switchProfTab('info')" id="prof-tab-info" style="flex:1;padding:0.8rem;background:#111;border:none;border-bottom:2px solid var(--white);color:var(--white);font-family:'IBM Plex Mono',monospace;font-size:0.6rem;letter-spacing:0.15em;cursor:pointer;">プロフィール</button>
      <button onclick="switchProfTab('manage')" id="prof-tab-manage" style="flex:1;padding:0.8rem;background:#111;border:none;border-bottom:2px solid transparent;color:#aaa;font-family:'IBM Plex Mono',monospace;font-size:0.6rem;letter-spacing:0.15em;cursor:pointer;">作品管理</button>
    </div>

    <!-- プロフィールタブ -->
    <div id="prof-tab-info-content" class="modal-content">
      <div style="display:flex;align-items:center;gap:1.5rem;margin-bottom:2rem;">
        <div id="prof-avatar" style="width:64px;height:64px;border-radius:50%;background:#222;border:1px solid #333;overflow:hidden;flex-shrink:0;display:flex;align-items:center;justify-content:center;">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#aaa" stroke-width="1.5"><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 3.6-7 8-7s8 3 8 7"/></svg>
        </div>
        <div>
          <div style="font-family:'Bebas Neue',sans-serif;font-size:2rem;letter-spacing:0.1em;margin-bottom:0.5rem;" id="prof-name"></div>
          <div style="font-size:0.85rem;color:#aaa;line-height:1.8;font-weight:300;" id="prof-bio"></div>
        </div>
      </div>
      <div id="prof-stats-all" style="display:grid;grid-template-columns:1fr 1fr 1fr;border:1px solid #333;margin-bottom:2rem;">
        <div style="padding:1.2rem 1.5rem;border-right:1px solid #333;">
          <span style="font-family:'IBM Plex Mono',monospace;font-size:0.55rem;color:#aaa;letter-spacing:0.2em;display:block;margin-bottom:0.4rem;">投稿数</span>
          <span style="font-family:'Bebas Neue',sans-serif;font-size:2rem;display:block;" id="prof-posts">0</span>
        </div>
        <div style="padding:1.2rem 1.5rem;border-right:1px solid #333;">
          <span style="font-family:'IBM Plex Mono',monospace;font-size:0.55rem;color:#aaa;letter-spacing:0.2em;display:block;margin-bottom:0.4rem;">譲渡実績</span>
          <span style="font-family:'Bebas Neue',sans-serif;font-size:2rem;display:block;" id="prof-transfers">0</span>
        </div>
        <div style="padding:1.2rem 1.5rem;">
          <span style="font-family:'IBM Plex Mono',monospace;font-size:0.55rem;color:#aaa;letter-spacing:0.2em;display:block;margin-bottom:0.4rem;">売上合計</span>
          <span style="font-family:'Bebas Neue',sans-serif;font-size:2rem;display:block;" id="prof-revenue">¥0</span>
        </div>
      </div>
      <!-- 他人閲覧時は投稿数のみ -->
      <div id="prof-stats-other" style="display:none;grid-template-columns:1fr;border:1px solid #333;margin-bottom:2rem;">
        <div style="padding:1.2rem 1.5rem;">
          <span style="font-family:'IBM Plex Mono',monospace;font-size:0.55rem;color:#aaa;letter-spacing:0.2em;display:block;margin-bottom:0.4rem;">投稿数</span>
          <span style="font-family:'Bebas Neue',sans-serif;font-size:2rem;display:block;" id="prof-posts-other">0</span>
        </div>
      </div>
      <div style="margin-bottom:1.5rem;">
        <div style="font-family:'IBM Plex Mono',monospace;font-size:0.6rem;color:#aaa;letter-spacing:0.2em;margin-bottom:1rem;">投稿作品</div>
        <div id="prof-works" style="display:flex;flex-direction:column;gap:1px;"></div>
      </div>
      <button class="btn-submit" id="prof-logout-btn" style="display:none;background:#333;color:#fff;" onclick="doLogout()">ログアウト</button>
    </div>

    <!-- 作品管理タブ -->
    <div id="prof-tab-manage-content" class="modal-content" style="display:none;">
      <div id="prof-manage-list" style="display:flex;flex-direction:column;gap:1px;"></div>
    </div>
  </div>
</div>

<!-- 作品テキスト編集モーダル（小説） -->
<div class="overlay" id="text-edit-overlay">
  <div class="modal" style="max-width:760px;">
    <div class="modal-top-bar">
      <span class="modal-label">本文を編集</span>
      <button class="modal-close" onclick="closeOverlay('text-edit-overlay')">✕</button>
    </div>
    <div class="modal-content">
      <div style="font-family:'IBM Plex Mono',monospace;font-size:0.55rem;color:#aaa;letter-spacing:0.15em;margin-bottom:0.5rem;">本文（段落ごとに空行で区切ってください）</div>
      <textarea id="text-edit-input" style="width:100%;background:#0d0d0d;border:1px solid var(--border);color:#ddd;padding:1.2rem;font-size:0.85rem;font-family:'Noto Serif JP',serif;line-height:2;resize:vertical;min-height:300px;outline:none;"></textarea>
      <div style="margin-top:1rem;display:flex;gap:0.75rem;">
        <button onclick="saveTextEdit()" style="background:var(--white);color:var(--black);border:none;padding:0.6rem 1.5rem;font-family:'IBM Plex Mono',monospace;font-size:0.65rem;letter-spacing:0.1em;cursor:pointer;">保存する →</button>
        <button onclick="openPreview('text')" style="background:none;border:1px solid var(--border);color:#aaa;padding:0.6rem 1.2rem;font-family:'IBM Plex Mono',monospace;font-size:0.65rem;letter-spacing:0.1em;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.borderColor='#fff';this.style.color='#fff'" onmouseout="this.style.borderColor='var(--border)';this.style.color='#aaa'">プレビュー</button>
        <button onclick="closeOverlay('text-edit-overlay')" style="background:none;border:1px solid var(--border);color:#aaa;padding:0.6rem 1.2rem;font-family:'IBM Plex Mono',monospace;font-size:0.65rem;letter-spacing:0.1em;cursor:pointer;">キャンセル</button>
      </div>
    </div>
  </div>
</div>

<!-- OVERVIEW MODAL（概要ウィンドウ） -->
<div class="overlay" id="overview-overlay">
  <div class="modal" style="max-width:680px;">
    <div class="modal-top-bar">
      <span class="work-format-badge" id="ov-format-label">漫画</span>
      <div style="display:flex;align-items:center;gap:0.75rem;">
        <button id="ov-edit-btn" onclick="openEditOverlay()" style="display:none;background:none;border:1px solid var(--border);color:var(--muted);font-family:'IBM Plex Mono',monospace;font-size:0.6rem;letter-spacing:0.1em;padding:0.3rem 0.8rem;transition:all 0.2s;">✎ 編集</button>
        <button class="modal-close" onclick="closeOverlay('overview-overlay')">✕</button>
      </div>
    </div>
    <div class="modal-content" style="padding:1.8rem 2rem;">

      <!-- ジャンル・タイトル -->
      <div style="font-family:'IBM Plex Mono',monospace;font-size:0.55rem;color:var(--muted);letter-spacing:0.25em;margin-bottom:0.5rem;" id="ov-genre"></div>
      <div style="font-family:'Noto Serif JP',serif;font-size:1.6rem;font-weight:700;line-height:1.3;margin-bottom:1.2rem;" id="ov-title"></div>

      <!-- 作者・日付 -->
      <div style="display:flex;align-items:center;gap:1rem;margin-bottom:1.8rem;">
        <span style="display:flex;align-items:center;gap:0.4rem;font-size:0.8rem;color:#aaa;">
          <span id="ov-author-icon" style="width:20px;height:20px;border-radius:50%;background:#222;display:inline-flex;align-items:center;justify-content:center;flex-shrink:0;overflow:hidden;">
            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="#777" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 3.6-7 8-7s8 3 8 7"/></svg>
          </span>
          <span id="ov-author" class="author-link" onclick="closeOverlay('overview-overlay'); openProfile(document.getElementById('ov-author').dataset.name)" style="cursor:pointer;"></span>
        </span>
        <span style="font-family:'IBM Plex Mono',monospace;font-size:0.6rem;color:#aaa;" id="ov-date"></span>
      </div>

      <!-- あらすじ -->
      <div style="background:#111;border-left:2px solid var(--red);padding:1.2rem 1.5rem;font-size:0.85rem;line-height:2;color:#ccc;font-weight:300;margin-bottom:2rem;" id="ov-synopsis"></div>

      <!-- 価格（テスト版のため非表示） -->
      <div style="display:flex;align-items:flex-end;justify-content:space-between;flex-wrap:wrap;gap:1rem;margin-bottom:2rem;padding-bottom:1.5rem;border-bottom:1px solid var(--border);">
        <div style="display:none;">
          <div style="font-family:'IBM Plex Mono',monospace;font-size:0.5rem;color:#aaa;letter-spacing:0.2em;margin-bottom:0.3rem;">完全譲渡価格</div>
          <div style="font-family:'Bebas Neue',sans-serif;font-size:2.2rem;line-height:1;" id="ov-price"></div>
          <div style="font-family:'IBM Plex Mono',monospace;font-size:0.55rem;color:#aaa;margin-top:0.2rem;">続編・商用利用・再販すべて可</div>
        </div>
        <div style="font-family:'IBM Plex Mono',monospace;font-size:0.55rem;color:#aaa;letter-spacing:0.05em;line-height:1.8;">続編・商用利用・再販すべて可<br>（テスト版のため無料で譲渡）</div>
        <div style="display:flex;gap:0.75rem;align-items:center;flex-wrap:wrap;">
          <button id="ov-acquire-btn" onclick="acquireAndWrite()" style="background:var(--white);color:var(--black);border:none;padding:0.9rem 2rem;font-family:'IBM Plex Mono',monospace;font-size:0.7rem;letter-spacing:0.15em;cursor:pointer;transition:opacity 0.2s;white-space:nowrap;">続きを書く →</button>
          <button id="ov-read-btn" onclick="readFromOverview()" style="background:none;color:var(--white);border:1px solid var(--border);padding:0.9rem 2rem;font-family:'IBM Plex Mono',monospace;font-size:0.7rem;letter-spacing:0.15em;cursor:pointer;transition:all 0.2s;white-space:nowrap;">作品を読む →</button>
        </div>
      </div>

      <!-- いいね・コメント数 -->
      <div style="display:flex;align-items:center;gap:1.5rem;margin-bottom:2rem;">
        <button id="ov-like-btn" onclick="toggleLikeFromOverview()" style="display:flex;align-items:center;gap:0.5rem;background:none;border:1px solid var(--border);padding:0.5rem 1rem;cursor:pointer;transition:all 0.2s;font-family:'IBM Plex Mono',monospace;font-size:0.65rem;letter-spacing:0.1em;color:#aaa;">
          <span id="ov-like-icon">♡</span>
          <span id="ov-like-count">0</span>
        </button>
        <span style="font-family:'IBM Plex Mono',monospace;font-size:0.65rem;color:#aaa;letter-spacing:0.05em;">
          コメント <span id="ov-comment-count">0</span>
        </span>
      </div>

      <!-- コメント一覧 -->
      <div id="ov-comments-list" style="display:flex;flex-direction:column;gap:1rem;margin-bottom:1.5rem;"></div>

      <!-- コメント入力 -->
      <div id="ov-comment-form" style="display:none;">
        <textarea id="ov-comment-input" placeholder="コメントを書く..." style="width:100%;background:#111;border:1px solid var(--border);color:#ddd;padding:1rem;font-size:0.85rem;font-family:inherit;line-height:1.8;resize:vertical;min-height:80px;outline:none;"></textarea>
        <button onclick="submitOverviewComment()" style="margin-top:0.5rem;background:var(--white);color:var(--black);border:none;padding:0.5rem 1.3rem;font-family:'IBM Plex Mono',monospace;font-size:0.65rem;letter-spacing:0.1em;cursor:pointer;">投稿する →</button>
      </div>
      <div id="ov-comment-login" style="display:none;font-family:'IBM Plex Mono',monospace;font-size:0.65rem;color:#aaa;">
        コメントするには<a href="#" onclick="closeOverlay('overview-overlay'); openLogin();" style="color:#aaa;text-decoration:underline;">ログイン</a>が必要です
      </div>

      <!-- 話数リスト（シリーズのみ） -->
      <div id="ov-ep-list" class="ep-list" style="display:none;"></div>
    </div>
  </div>
</div>

<!-- READER FULL PAGE（小説読書ページ） -->
<div class="reader-page-wrap" id="reader-page">
  <div class="reader-page-header" style="justify-content:space-between;">
    <button class="reader-back-btn" onclick="closeReader()">← 概要に戻る</button>
    <span id="r-page-title" style="font-family:'IBM Plex Mono',monospace;font-size:0.65rem;color:#aaa;letter-spacing:0.1em;"></span>
  </div>
  <div class="reader-content" id="r-body"></div>
  <!-- スクロール最下部：アクションバー -->
  <div id="r-sequel-bar" style="display:none;position:sticky;bottom:0;background:#f9f6f1;border-top:2px solid #111;padding:1.2rem 1.5rem;flex-wrap:wrap;gap:1rem;align-items:center;justify-content:space-between;">
    <div>
      <div style="font-family:'Noto Serif JP',serif;font-size:0.9rem;color:#111;">この作品の続きを書きませんか？</div>
    </div>
    <div style="display:flex;align-items:center;gap:0.75rem;flex-wrap:wrap;">
      <button id="r-like-btn" onclick="toggleLikeFromReader()" style="display:flex;align-items:center;gap:0.4rem;background:none;border:1px solid #ccc;padding:0.5rem 1rem;font-family:'IBM Plex Mono',monospace;font-size:0.6rem;letter-spacing:0.1em;color:#aaa;cursor:pointer;transition:all 0.2s;">
        <span id="r-like-icon">♡</span><span id="r-like-count">0</span>
      </button>
      <button onclick="openCommentFromReader()" style="display:flex;align-items:center;gap:0.4rem;background:none;border:1px solid #ccc;padding:0.5rem 1rem;font-family:'IBM Plex Mono',monospace;font-size:0.6rem;letter-spacing:0.1em;color:#aaa;cursor:pointer;transition:all 0.2s;">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
        <span id="r-comment-count">0</span>
      </button>
      <button onclick="acquireAndWrite()" style="background:#111;color:#fff;border:none;padding:0.6rem 1.3rem;font-family:'IBM Plex Mono',monospace;font-size:0.6rem;letter-spacing:0.12em;cursor:pointer;white-space:nowrap;">続きを書く →</button>
    </div>
  </div>
</div>

<!-- EDIT OVERLAY（投稿者のみ） -->
<div class="overlay" id="edit-overlay">
  <div class="modal">
    <div class="modal-top-bar">
      <span class="modal-label">作品を編集する</span>
      <button class="modal-close" onclick="closeOverlay('edit-overlay')">✕</button>
    </div>
    <div class="modal-content">
      <div class="form-block">
        <label class="form-lbl">タイトル</label>
        <input type="text" class="form-ctrl" id="e-title">
      </div>
      <div class="form-row">
        <div class="form-block">
          <label class="form-lbl">形式</label>
          <select class="form-ctrl" id="e-format">
            <option value="manga">漫画</option>
            <option value="novel">小説</option>
          </select>
        </div>
        <div class="form-block">
          <label class="form-lbl">ジャンル</label>
          <input type="text" class="form-ctrl" id="e-genre">
        </div>
      </div>
      <div class="form-block">
        <label class="form-lbl">あらすじ・紹介文</label>
        <textarea class="form-ctrl" id="e-synopsis" style="min-height:120px;"></textarea>
      </div>
      <div class="form-block">
        <label class="form-lbl">譲渡価格（¥）</label>
        <div id="e-price-display" style="display:none;"></div>
        <input type="hidden" id="e-price">
        <div style="background:var(--dim);border:1px solid var(--border);padding:0.9rem 1rem;font-family:'IBM Plex Mono',monospace;font-size:0.6rem;color:#555;letter-spacing:0.1em;">テスト版のため設定できません</div>
      </div>

      <!-- 小説本文編集 -->
      <div class="form-block" id="e-novel-block" style="display:none;">
        <label class="form-lbl">本文（空行で段落区切り）</label>
        <textarea class="form-ctrl" id="e-body" style="min-height:240px;line-height:2;font-family:'Noto Serif JP',serif;font-size:0.85rem;resize:vertical;"></textarea>
      </div>

      <!-- 漫画原稿編集 -->
      <div class="form-block" id="e-manga-block" style="display:none;">
        <label class="form-lbl">漫画原稿</label>
        <div id="e-manga-pages" style="display:flex;flex-wrap:wrap;gap:0.5rem;margin-bottom:0.75rem;"></div>
        <div style="display:flex;gap:0.5rem;align-items:center;flex-wrap:wrap;">
          <input type="file" id="e-manga-add" accept="image/*" multiple style="display:none;" onchange="editMangaAdd(this)">
          <button onclick="document.getElementById('e-manga-add').click()" style="background:none;border:1px solid var(--border);color:#aaa;padding:0.4rem 1rem;font-family:'IBM Plex Mono',monospace;font-size:0.6rem;letter-spacing:0.1em;cursor:pointer;">+ ページを追加</button>
          <span style="font-family:'IBM Plex Mono',monospace;font-size:0.5rem;color:#aaa;letter-spacing:0.1em;">ドラッグで順番入れ替え・×で削除</span>
        </div>
      </div>

      <div style="display:flex;gap:0.75rem;margin-top:0.5rem;">
        <button class="btn-submit" onclick="saveEdit()" style="flex:1;">保存する →</button>
        <button onclick="openPreview('edit')" style="background:none;border:1px solid var(--border);color:#aaa;padding:0.8rem 1.5rem;font-family:'IBM Plex Mono',monospace;font-size:0.7rem;letter-spacing:0.15em;cursor:pointer;transition:all 0.2s;white-space:nowrap;" onmouseover="this.style.borderColor='#fff';this.style.color='#fff'" onmouseout="this.style.borderColor='var(--border)';this.style.color='#aaa'">プレビュー</button>
      </div>
    </div>
  </div>
</div>

<!-- PREVIEW PAGE（読書ページと同じ表示） -->
<div class="reader-page-wrap" id="preview-page" style="z-index:1100;">
  <div class="reader-page-header" style="justify-content:space-between;">
    <button class="reader-back-btn" onclick="document.getElementById('preview-page').classList.remove('open');document.body.style.overflow='';">← 編集に戻る</button>
    <span style="font-family:'IBM Plex Mono',monospace;font-size:0.6rem;color:#aaa;letter-spacing:0.15em;">PREVIEW</span>
  </div>
  <div class="reader-content" id="pv-body"></div>
</div>

<div class="toast" id="toast"></div>

<script>
// --- SUPABASE ---
const SUPABASE_URL = 'https://gfpwasvmfjiwpyjlamth.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdmcHdhc3ZtZmppd3B5amxhbXRoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4MjEyODEsImV4cCI6MjA4NzM5NzI4MX0._dWKmTSLJzZ6uNzwFk3fAj-qx4_zDe5zWB3qGhSdkcE';
const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// PAY.JP 公開鍵（テスト環境）
const PAYJP_PUBLIC_KEY = 'ここにpk_test_...を貼り付ける';

// --- AUTH ---
let currentUser = null;
let avatarCache = {}; // { name: avatarUrl } のキャッシュ

// --- WORKS ---
let works = [];

let currentFilter = 'all';
let currentId = null;

function available() { return works.filter(w => w.status === 'available'); }

// シリーズの最新話IDセットを返す
function latestEpisodeIds() {
  const seriesMap = {};
  available().forEach(w => {
    if (!w.seriesId) return;
    if (!seriesMap[w.seriesId] || w.episode > seriesMap[w.seriesId].episode) {
      seriesMap[w.seriesId] = w;
    }
  });
  return new Set(Object.values(seriesMap).map(w => w.id));
}

// ホーム用：シリーズは最新話のみ表示、日付降順
function filtered() {
  const av = available();
  const latest = latestEpisodeIds();
  const visible = av.filter(w => !w.seriesId || latest.has(w.id));
  const byFormat = currentFilter === 'all' ? visible : visible.filter(w => w.format === currentFilter);
  return byFormat.sort((a, b) => new Date(b.date) - new Date(a.date));
}

// シリーズの全話を話数昇順で返す
function getSeriesEpisodes(seriesId) {
  return available()
    .filter(w => w.seriesId === seriesId)
    .sort((a, b) => a.episode - b.episode);
}

function updateStats() {
  // statsバー削除済み
}

function render() {
  const list = document.getElementById('works-list');
  const data = filtered();
  updateStats();

  if (!data.length) {
    list.innerHTML = `<div class="empty-state"><p>該当する作品がありません</p></div>`;
    return;
  }

  list.innerHTML = data.map((w, i) => {
    // シリーズ情報
    const episodes = w.seriesId ? getSeriesEpisodes(w.seriesId) : null;
    const totalEp  = episodes ? episodes.length : 1;
    const daysSince = (Date.now() - new Date(w.date).getTime()) / (1000 * 60 * 60 * 24);
    const isNew    = daysSince <= 7;
    const epLabel  = w.seriesId ? ` ${w.episode}話` : '';
    const newBadge = isNew ? `<span class="new-badge">NEW</span>` : '';

    return `
    <div class="work-card" style="animation-delay:${i * 0.07}s">
      <div class="work-left">
        <div class="work-num">0${i+1}</div>
        <span class="work-format-badge ${w.format}">${w.format === 'manga' ? '漫画' : '小説'}</span>
      </div>
      <div class="work-mid" onclick="openOverview(${w.id})" style="cursor:pointer;">
        <div>
          <div class="work-genre">${w.genre}</div>
          <div class="work-title">${w.title}${epLabel ? `<span class="ep-badge">${epLabel}</span>` : ''}${newBadge}</div>
        </div>
        <div class="work-synopsis">${w.synopsis}</div>
        <div class="work-bottom-row">
          <span class="work-meta author-link" onclick="event.stopPropagation(); openProfile('${w.author}')" style="display:flex;align-items:center;gap:0.4rem;">
            <span style="width:18px;height:18px;border-radius:50%;background:#333;display:inline-flex;align-items:center;justify-content:center;flex-shrink:0;overflow:hidden;">
              ${avatarCache[w.author]
                ? `<img src="${avatarCache[w.author]}" style="width:100%;height:100%;object-fit:cover;">`
                : `<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="#aaa" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 3.6-7 8-7s8 3 8 7"/></svg>`
              }
            </span>
            ${w.author}
          </span>
          <span class="work-meta">${w.date}</span>
          <span class="work-reactions">
            <span class="reaction-item" onclick="event.stopPropagation(); toggleLike(${w.id})">
              <span class="reaction-icon">${w.liked ? '♥' : '♡'}</span>
              <span class="reaction-count">${w.likes}</span>
            </span>
            <span class="reaction-item" onclick="event.stopPropagation(); openOverview(${w.id})">
              <span class="reaction-icon">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
              </span>
              <span class="reaction-count">${w.comments.length}</span>
            </span>
          </span>
        </div>
      </div>
      <div class="work-right">
        <div class="work-price" style="display:none;">
          <span class="work-price-num">${w.price === 0 ? '¥0' : '¥' + w.price.toLocaleString()}</span>
          <span class="work-price-label">完全譲渡</span>
        </div>
        <button class="btn-card primary" onclick="directRead(${w.id})">作品を読む →</button>
      </div>
    </div>
  `}).join('');
}

function setFilter(type) {
  currentFilter = type;
  document.querySelectorAll('nav a').forEach(a => a.classList.remove('active'));
  const navLinks = document.querySelectorAll('nav a');
  if (type === 'all') navLinks[0].classList.add('active');
  if (type === 'manga') navLinks[1].classList.add('active');
  if (type === 'novel') navLinks[2].classList.add('active');
  render();
}

// --- AUTH UI ---
const AVATAR_PLACEHOLDER = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 3.6-7 8-7s8 3 8 7"/></svg>`;

function updateAuthUI() {
  const btn = document.getElementById('nav-auth-btn');
  if (currentUser) {
    btn.className = '';
    btn.style.cssText = 'display:flex;align-items:stretch;border-left:none;padding:0;cursor:crosshair;';
    btn.onclick = handleAuthClick;
    btn.innerHTML = `
      <div class="nav-avatar-wrap">
        <div class="nav-avatar">${currentUser.avatar_url ? `<img src="${currentUser.avatar_url}">` : AVATAR_PLACEHOLDER}</div>
        <span class="nav-avatar-name">${currentUser.name}</span>
      </div>`;
  } else {
    btn.className = 'nav-post';
    btn.style.cssText = '';
    btn.onclick = handleAuthClick;
    btn.textContent = 'ログイン';
  }
}

function handleAuthClick(e) {
  e.preventDefault();
  if (!currentUser) { openLogin(); return; }
  const dd = document.getElementById('nav-dropdown');
  dd.classList.toggle('open');
}

// ドロップダウンを外クリックで閉じる
document.addEventListener('click', e => {
  const wrap = document.getElementById('nav-user-wrap');
  if (wrap && !wrap.contains(e.target)) {
    document.getElementById('nav-dropdown').classList.remove('open');
  }
});

function goToMyProfile() {
  document.getElementById('nav-dropdown').classList.remove('open');
  openProfile(currentUser.name);
}

function openSettings() {
  document.getElementById('nav-dropdown').classList.remove('open');
  document.getElementById('s-name').value = currentUser.name;
  document.getElementById('s-bio').value = currentUser.bio || '';

  // アバタープレビューを現在の画像で更新
  const preview = document.getElementById('s-avatar-preview');
  const deleteBtn = document.getElementById('s-avatar-delete-btn');
  if (currentUser.avatar_url) {
    preview.innerHTML = `<img src="${currentUser.avatar_url}" style="width:100%;height:100%;object-fit:cover;">`;
    deleteBtn.style.display = 'block';
  } else {
    preview.innerHTML = `<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#aaa" stroke-width="1.5"><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 3.6-7 8-7s8 3 8 7"/></svg>`;
    deleteBtn.style.display = 'none';
  }

  switchSettingsTab('profile');
  document.getElementById('settings-overlay').classList.add('open');
}

async function saveSettings() {
  const name = document.getElementById('s-name').value.trim();
  const bio  = document.getElementById('s-bio').value.trim();
  if (!name) { toast('ペンネームを入力してください'); return; }

  const oldName = currentUser.name;
  const nameChanged = name !== oldName;

  // アバター画像のアップロード
  let avatarUrl = currentUser.avatar_url || null;
  const avatarFile = document.getElementById('s-avatar-file').files[0];
  if (avatarFile) {
    const ext  = avatarFile.name.split('.').pop().toLowerCase();
    const path = `${currentUser.id}.${ext}`;
    // 既存ファイルを削除してから再アップロード
    await db.storage.from('avatars').remove([path]);
    const { error: uploadError } = await db.storage.from('avatars').upload(path, avatarFile, {
      contentType: avatarFile.type,
    });
    if (uploadError) { toast('画像のアップロード失敗: ' + uploadError.message); return; }
    avatarUrl = db.storage.from('avatars').getPublicUrl(path).data.publicUrl;
  }

  const { error } = await db.from('profiles')
    .update({ name, bio, avatar_url: avatarUrl })
    .eq('id', currentUser.id);
  if (error) { toast('更新失敗: ' + error.message); return; }

  if (nameChanged) {
    await db.from('works').update({ author: name }).eq('author_id', currentUser.id);
    works.forEach(w => { if (w.author_id === currentUser.id) w.author = name; });
  }

  currentUser.name   = name;
  currentUser.bio    = bio;
  currentUser.avatar_url = avatarUrl;
  avatarCache[name]  = avatarUrl; // キャッシュ更新
  if (nameChanged) avatarCache[oldName] = undefined;
  updateAuthUI();
  render();
  closeOverlay('settings-overlay');
  toast('プロフィールを更新しました');
}

async function deleteAvatar() {
  if (!currentUser || !currentUser.avatar_url) return;

  // Storageから削除
  const path = currentUser.avatar_url.split('/avatars/')[1]?.split('?')[0];
  if (path) await db.storage.from('avatars').remove([path]);

  // DBをnullに更新
  const { error } = await db.from('profiles').update({ avatar_url: null }).eq('id', currentUser.id);
  if (error) { toast('削除に失敗しました'); return; }

  currentUser.avatar_url = null;
  avatarCache[currentUser.name] = null;

  const preview = document.getElementById('s-avatar-preview');
  preview.innerHTML = `<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#aaa" stroke-width="1.5"><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 3.6-7 8-7s8 3 8 7"/></svg>`;
  document.getElementById('s-avatar-delete-btn').style.display = 'none';
  document.getElementById('s-avatar-file').value = '';

  updateAuthUI();
  render();
  toast('プロフィール画像を削除しました');
}

function previewAvatar(input) {
  if (!input.files[0]) return;
  const url     = URL.createObjectURL(input.files[0]);
  const preview = document.getElementById('s-avatar-preview');
  preview.innerHTML = `<img src="${url}" style="width:100%;height:100%;object-fit:cover;">`;
  document.getElementById('s-avatar-delete-btn').style.display = 'block';
}

function switchSettingsTab(tab) {
  ['profile', 'account', 'danger'].forEach(t => {
    document.getElementById(`settings-content-${t}`).style.display = t === tab ? 'block' : 'none';
    const btn = document.getElementById(`settings-tab-${t}`);
    btn.style.borderBottomColor = t === tab ? 'var(--white)' : 'transparent';
    btn.style.color = t === tab ? 'var(--white)' : '#555';
  });
}

async function updateEmail() {
  const email = document.getElementById('s-email').value.trim();
  if (!email) { toast('メールアドレスを入力してください'); return; }
  const { error } = await db.auth.updateUser({ email });
  if (error) { toast('変更失敗: ' + error.message); return; }
  toast('確認メールを送信しました。メールを確認してください');
  document.getElementById('s-email').value = '';
}

async function sendPasswordReset() {
  const email = currentUser?.email;
  if (!email) { toast('メールアドレスが取得できません'); return; }
  const { error } = await db.auth.resetPasswordForEmail(email, {
    redirectTo: window.location.href,
  });
  if (error) { toast('送信失敗: ' + error.message); return; }
  toast('パスワード変更リンクを送信しました');
}

function confirmWithdrawal() {
  if (!confirm('本当に退会しますか？\nこの操作は取り消せません。')) return;
  toast('退会機能は現在準備中です');
  // TODO: 退会処理の実装
}

function openLogin() {
  document.getElementById('login-overlay').classList.add('open');
}

// ログイン/サインアップ切り替え
function switchToSignup() {
  document.getElementById('login-form').style.display = 'none';
  document.getElementById('signup-form').style.display = 'block';
  document.getElementById('login-modal-label').textContent = 'アカウント作成';
}
function switchToLogin() {
  document.getElementById('signup-form').style.display = 'none';
  document.getElementById('login-form').style.display = 'block';
  document.getElementById('login-modal-label').textContent = 'ログイン';
}

async function doLogin() {
  const email    = document.getElementById('login-email').value.trim();
  const password = document.getElementById('login-password').value;
  if (!email || !password) { toast('メールとパスワードを入力してください'); return; }

  const { data, error } = await db.auth.signInWithPassword({ email, password });
  if (error) { toast('ログイン失敗: ' + error.message); return; }

  await loadCurrentUser(data.user);
  closeOverlay('login-overlay');
  toast(`${currentUser.name} としてログインしました`);
}

async function doSignup() {
  const name     = document.getElementById('signup-name').value.trim();
  const email    = document.getElementById('signup-email').value.trim();
  const password = document.getElementById('signup-password').value;
  if (!name || !email || !password) { toast('すべての項目を入力してください'); return; }
  if (password.length < 6) { toast('パスワードは6文字以上にしてください'); return; }

  const { data, error } = await db.auth.signUp({ email, password });
  if (error) { toast('登録失敗: ' + error.message); return; }

  // profilesテーブルにユーザー情報を保存
  await db.from('profiles').insert({ id: data.user.id, name, bio: '', posts: 0, transfers: 0 });

  await loadCurrentUser(data.user);
  closeOverlay('login-overlay');
  toast(`${name} として登録しました`);
}

async function loadCurrentUser(user) {
  const { data } = await db.from('profiles').select('*').eq('id', user.id).single();
  if (data) {
    currentUser = { ...data, email: user.email };
  }
  updateAuthUI();
}

async function doLogout() {
  await db.auth.signOut();
  currentUser = null;
  document.getElementById('nav-dropdown').classList.remove('open');
  closeOverlay('profile-overlay');
  updateAuthUI();
  toast('ログアウトしました');
}

// --- PROFILE ---
let currentProfileName = '';

function switchProfTab(tab) {
  const isInfo = tab === 'info';
  document.getElementById('prof-tab-info-content').style.display = isInfo ? 'block' : 'none';
  document.getElementById('prof-tab-manage-content').style.display = isInfo ? 'none' : 'block';
  document.getElementById('prof-tab-info').style.borderBottomColor = isInfo ? 'var(--white)' : 'transparent';
  document.getElementById('prof-tab-info').style.color = isInfo ? 'var(--white)' : '#555';
  document.getElementById('prof-tab-manage').style.borderBottomColor = isInfo ? 'transparent' : 'var(--white)';
  document.getElementById('prof-tab-manage').style.color = isInfo ? '#555' : 'var(--white)';
  if (!isInfo) renderManageList();
}

async function openProfile(authorName) {
  currentProfileName = authorName;

  // Supabaseからプロフィール取得
  const { data: u } = await db.from('profiles').select('*').eq('name', authorName).single();
  const profile = u || { name: authorName, bio: '', posts: 0, transfers: 0 };

  const isMe = currentUser && currentUser.name === authorName;
  const authorWorks = works.filter(w => w.author === authorName);
  const transferred = works.filter(w => w.author === authorName && w.status === 'sold').length;
  const revenue = works.filter(w => w.author === authorName && w.status === 'sold').reduce((s,w) => s+w.price, 0);

  document.getElementById('prof-name').textContent = profile.name;
  document.getElementById('prof-bio').textContent = profile.bio || 'プロフィール未設定';

  // アバター表示
  const profAvatar = document.getElementById('prof-avatar');
  if (profile.avatar_url) {
    profAvatar.innerHTML = `<img src="${profile.avatar_url}" style="width:100%;height:100%;object-fit:cover;">`;
  } else {
    profAvatar.innerHTML = `<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#aaa" stroke-width="1.5"><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 3.6-7 8-7s8 3 8 7"/></svg>`;
  }
  document.getElementById('prof-posts').textContent = authorWorks.length;
  document.getElementById('prof-transfers').textContent = transferred;
  document.getElementById('prof-revenue').textContent = `¥${revenue.toLocaleString()}`;
  document.getElementById('prof-logout-btn').style.display = isMe ? 'block' : 'none';

  // 本人なら全統計、他人なら投稿数のみ
  document.getElementById('prof-stats-all').style.display = isMe ? 'grid' : 'none';
  document.getElementById('prof-stats-other').style.display = isMe ? 'none' : 'grid';
  document.getElementById('prof-posts-other').textContent = authorWorks.length;

  // タブ：本人のみ「作品管理」タブ表示
  const tabs = document.getElementById('prof-tabs');
  tabs.style.display = isMe ? 'flex' : 'none';

  // プロフィールタブをデフォルト表示
  switchProfTab('info');

  const workList = document.getElementById('prof-works');
  if (authorWorks.length === 0) {
    workList.innerHTML = `<p style="font-family:'IBM Plex Mono',monospace;font-size:0.7rem;color:#aaa;letter-spacing:0.1em;">投稿作品なし</p>`;
  } else {
    workList.innerHTML = authorWorks.map(w => `
      <div class="prof-work-item" onclick="closeOverlay('profile-overlay'); openOverview(${w.id})">
        <span class="work-format-badge ${w.format}" style="font-size:0.5rem;padding:0.2rem 0.5rem;">${w.format === 'manga' ? '漫画' : '小説'}</span>
        <span class="prof-work-title">${w.title}</span>
        <span class="prof-work-status ${w.status === 'sold' ? 'sold' : ''}">${w.status === 'sold' ? '譲渡済' : '募集中'}</span>
      </div>
    `).join('');
  }

  document.getElementById('profile-overlay').classList.add('open');
}

// --- 作品管理 ---
async function renderManageList() {
  const myWorks = works.filter(w => w.author === currentProfileName);
  const list = document.getElementById('prof-manage-list');

  // 下書きを取得して先頭に表示
  let draftHtml = '';
  if (currentUser && currentUser.name === currentProfileName) {
    const { data: drafts } = await db.from('drafts').select('*').eq('user_id', currentUser.id).limit(1);
    const draft = drafts && drafts.length > 0 ? drafts[0] : null;
    if (draft) {
      const updatedAt = new Date(draft.updated_at).toLocaleString('ja-JP');
      draftHtml = `
        <div style="border:1px solid #444;margin-bottom:-1px;padding:1.2rem 1.5rem;background:#0d0d0d;">
          <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:0.75rem;">
            <div>
              <div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.3rem;">
                <span style="font-family:'IBM Plex Mono',monospace;font-size:0.5rem;color:#aaa;border:1px solid #555;padding:0.2rem 0.5rem;letter-spacing:0.1em;">下書き</span>
                <span style="font-family:'Noto Serif JP',serif;font-size:1rem;font-weight:700;">${draft.title || '（タイトル未入力）'}</span>
              </div>
              <div style="font-family:'IBM Plex Mono',monospace;font-size:0.55rem;color:#aaa;letter-spacing:0.1em;">${updatedAt} 保存</div>
            </div>
            <div style="display:flex;gap:0.5rem;">
              <button onclick="closeOverlay('profile-overlay');openPost();" style="background:none;border:1px solid var(--border);color:#aaa;padding:0.4rem 0.8rem;font-family:'IBM Plex Mono',monospace;font-size:0.55rem;letter-spacing:0.1em;cursor:pointer;">✎ 編集を再開</button>
              <button onclick="deleteDraft()" style="background:none;border:1px solid #662222;color:#aa4444;padding:0.4rem 0.8rem;font-family:'IBM Plex Mono',monospace;font-size:0.55rem;letter-spacing:0.1em;cursor:pointer;">削除</button>
            </div>
          </div>
        </div>
      `;
    }
  }

  if (myWorks.length === 0 && !draftHtml) {
    list.innerHTML = `<p style="font-family:'IBM Plex Mono',monospace;font-size:0.7rem;color:#aaa;letter-spacing:0.1em;padding:1rem 0;">投稿作品なし</p>`;
    return;
  }
  list.innerHTML = draftHtml + myWorks.map(w => `
    <div style="border:1px solid var(--border);margin-bottom:-1px;padding:1.2rem 1.5rem;">
      <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:0.75rem;">
        <div>
          <div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.3rem;">
            <span class="work-format-badge ${w.format}" style="font-size:0.5rem;padding:0.2rem 0.5rem;">${w.format === 'manga' ? '漫画' : '小説'}</span>
            <span style="font-family:'Noto Serif JP',serif;font-size:1rem;font-weight:700;">${w.title}</span>
          </div>
          <div style="font-family:'IBM Plex Mono',monospace;font-size:0.55rem;color:#aaa;letter-spacing:0.1em;">${w.date} &nbsp;·&nbsp; ♡${w.likes} &nbsp;·&nbsp; <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg> ${(w.comments||[]).length}</div>
        </div>
        <div style="display:flex;gap:0.5rem;flex-wrap:wrap;">
          <button onclick="openManageEdit(${w.id})" style="background:none;border:1px solid var(--border);color:#aaa;padding:0.4rem 0.8rem;font-family:'IBM Plex Mono',monospace;font-size:0.55rem;letter-spacing:0.1em;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.borderColor='#fff';this.style.color='#fff'" onmouseout="this.style.borderColor='var(--border)';this.style.color='#aaa'">✎ 編集</button>
          ${w.format === 'novel' && w.body ? `<button onclick="openTextEdit(${w.id})" style="background:none;border:1px solid #4488ff;color:#4488ff;padding:0.4rem 0.8rem;font-family:'IBM Plex Mono',monospace;font-size:0.55rem;letter-spacing:0.1em;cursor:pointer;transition:all 0.2s;">本文編集</button>` : ''}
          ${w.format === 'manga' ? `<label style="background:none;border:1px solid var(--red);color:var(--red);padding:0.4rem 0.8rem;font-family:'IBM Plex Mono',monospace;font-size:0.55rem;letter-spacing:0.1em;cursor:pointer;transition:all 0.2s;"><input type="file" accept="image/*" multiple style="display:none;" onchange="replaceMangaFiles(${w.id}, this)">差し替え</label>` : ''}
          <button onclick="confirmDelete(${w.id})" style="background:none;border:1px solid #662222;color:#aa4444;padding:0.4rem 0.8rem;font-family:'IBM Plex Mono',monospace;font-size:0.55rem;letter-spacing:0.1em;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.background='#330000'" onmouseout="this.style.background='none'">削除</button>
        </div>
      </div>
    </div>
  `).join('');
}

async function deleteDraft() {
  await db.from('drafts').delete().eq('user_id', currentUser.id);
  toast('下書きを削除しました');
  renderManageList();
}

function openManageEdit(id) {
  closeOverlay('profile-overlay');
  currentId = id;
  openEditOverlay();
}

function openTextEdit(id) {
  const w = works.find(x => x.id === id);
  if (!w || !w.body) return;
  currentId = id;
  // body配列を段落区切りの文字列に変換
  document.getElementById('text-edit-input').value = w.body.join('\n\n');
  document.getElementById('text-edit-overlay').classList.add('open');
}

function saveTextEdit() {
  const w = works.find(x => x.id === currentId);
  if (!w) return;
  const raw = document.getElementById('text-edit-input').value.trim();
  if (!raw) { toast('本文を入力してください'); return; }
  // 空行で段落分割
  w.body = raw.split(/\n{2,}/).map(p => p.trim()).filter(p => p.length > 0);
  closeOverlay('text-edit-overlay');
  renderManageList();
  render();
  toast('本文を更新しました');
}

function replaceMangaFiles(id, input) {
  const w = works.find(x => x.id === id);
  if (!w || !input.files || input.files.length === 0) return;
  const files = Array.from(input.files).sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true }));
  const readers = files.map(file => new Promise(resolve => {
    const r = new FileReader();
    r.onload = e => resolve(e.target.result);
    r.readAsDataURL(file);
  }));
  Promise.all(readers).then(dataUrls => {
    w.mangaPages = dataUrls;
    w.mangaUrl = null; // 外部URLから内部データへ切り替え
    renderManageList();
    toast(`${files.length}ページの画像を差し替えました`);
  });
}

function confirmDelete(id) {
  const w = works.find(x => x.id === id);
  if (!w) return;
  if (!confirm(`「${w.title}」を削除しますか？この操作は元に戻せません。`)) return;
  const idx = works.findIndex(x => x.id === id);
  if (idx !== -1) works.splice(idx, 1);
  renderManageList();
  // プロフィールの投稿作品欄も更新
  if (currentUser) openProfile(currentUser.name);
  else closeOverlay('profile-overlay');
  render();
  toast('作品を削除しました');
}

// --- DETAIL ---
function openDetail(id) {
  const w = works.find(x => x.id === id);
  if (!w) return;
  currentId = id;

  document.getElementById('d-badges').innerHTML = `<span class="work-format-badge ${w.format}">${w.format === 'manga' ? '漫画' : '小説'}</span>`;
  document.getElementById('d-title').textContent = w.title;
  document.getElementById('d-synopsis').textContent = w.synopsis;
  document.getElementById('d-genre').textContent = w.genre;
  document.getElementById('d-author').innerHTML = `<span class="author-link" onclick="closeOverlay('detail-overlay'); openProfile('${w.author}')">${w.author}</span>`;
  document.getElementById('d-format').textContent = w.format === 'manga' ? '漫画' : '小説';
  document.getElementById('d-date').textContent = w.date;
  document.getElementById('d-price').textContent = w.price === 0 ? '¥0' : `¥${w.price.toLocaleString()}`;
  document.getElementById('d-price').style.color = 'var(--white)';

  const btn = document.getElementById('d-acquire-btn');
  if (w.status === 'sold') {
    btn.textContent = '譲渡済み';
    btn.style.background = '#222';
    btn.style.color = '#555';
    btn.style.cursor = 'default';
    btn.onclick = null;
  } else if (!currentUser) {
    btn.textContent = 'ログインして続きを書く';
    btn.style.background = '#333';
    btn.style.color = '#666';
    btn.style.cursor = 'pointer';
    btn.onclick = () => { closeOverlay('detail-overlay'); openLogin(); };
  } else if (w.author_id === currentUser.id) {
    btn.textContent = '自分の作品';
    btn.style.background = '#222';
    btn.style.color = '#555';
    btn.style.cursor = 'default';
    btn.onclick = null;
  } else {
    btn.textContent = '続きを書く →';
    btn.style.background = '';
    btn.style.color = '';
    btn.style.cursor = 'pointer';
    btn.onclick = acquireAndWrite;
  }

  document.getElementById('d-read-btn').style.display = w.body ? 'block' : 'none';

  document.getElementById('detail-overlay').classList.add('open');
}

function openReaderFromDetail() {
  closeOverlay('detail-overlay');
  openReader(currentId);
}



// --- POST ---
function openPost() {
  if (!currentUser) { openLogin(); return; }

  // 形式切り替えで漫画/小説の入力欄を制御
  const formatEl = document.getElementById('f-format');
  const mangaBlock = document.getElementById('f-manga-block');
  const novelBlock = document.getElementById('f-novel-block');

  const updateBlocks = () => {
    mangaBlock.style.display = formatEl.value === 'manga' ? 'block' : 'none';
    novelBlock.style.display = formatEl.value === 'novel' ? 'block' : 'none';
  };
  updateBlocks();
  formatEl.onchange = updateBlocks;

  // ファイル選択時にサムネプレビュー（追加・並び替え対応）
  document.getElementById('f-manga-files').onchange = (e) => {
    mangaFileOrder = [...mangaFileOrder, ...[...e.target.files]];
    renderMangaPreview();
  };

  document.getElementById('post-overlay').classList.add('open');

  // 下書きがあれば自動読み込み
  setTimeout(loadDraft, 300);
}

// ドラッグ中のアイテム
let dragSrcIndex = null;
let mangaFileOrder = []; // File オブジェクトを順番管理

function renderMangaPreview() {
  const preview = document.getElementById('f-manga-preview');
  const hint    = document.getElementById('f-manga-hint');
  preview.innerHTML = '';
  hint.style.display = mangaFileOrder.length > 1 ? 'block' : 'none';

  mangaFileOrder.forEach((file, i) => {
    const url  = URL.createObjectURL(file);
    const item = document.createElement('div');
    item.style.cssText = 'position:relative;cursor:grab;user-select:none;';
    item.draggable = true;
    item.dataset.index = i;
    item.innerHTML = `
      <img src="${url}" style="width:60px;height:80px;object-fit:cover;border:1px solid #333;display:block;">
      <div style="font-family:'IBM Plex Mono',monospace;font-size:0.4rem;color:#aaa;text-align:center;">${i+1}p</div>
      <button onclick="mangaFileOrder.splice(${i},1);renderMangaPreview();" style="position:absolute;top:2px;right:2px;width:16px;height:16px;background:#900;border:none;color:#fff;font-size:0.55rem;cursor:pointer;line-height:1;padding:0;">×</button>
    `;

    item.addEventListener('dragstart', () => { dragSrcIndex = i; item.style.opacity = '0.4'; });
    item.addEventListener('dragend',   () => { item.style.opacity = '1'; });
    item.addEventListener('dragover',  e => e.preventDefault());
    item.addEventListener('drop', () => {
      if (dragSrcIndex === null || dragSrcIndex === i) return;
      const moved = mangaFileOrder.splice(dragSrcIndex, 1)[0];
      mangaFileOrder.splice(i, 0, moved);
      dragSrcIndex = null;
      renderMangaPreview();
    });

    preview.appendChild(item);
  });
}

function closePost() {
  closeOverlay('post-overlay');
  mangaFileOrder = [];
  document.getElementById('f-manga-files').value = '';
  document.getElementById('f-manga-preview').innerHTML = '';
  document.getElementById('f-manga-hint').style.display = 'none';
  // 続編モードをリセット
  if (sequelSourceWork) {
    sequelSourceWork = null;
    document.getElementById('f-modal-label').textContent = '新規投稿';
    document.getElementById('f-normal-fields').style.display = 'block';
    document.getElementById('f-sequel-info').style.display = 'none';
  }
}

// カスタム確認ダイアログ
function showConfirm(title, message, okLabel = '確認') {
  return new Promise(resolve => {
    document.getElementById('confirm-title').textContent = title;
    document.getElementById('confirm-message').innerHTML = message;
    document.getElementById('confirm-ok-btn').textContent = okLabel;
    document.getElementById('confirm-overlay').classList.add('open');

    const okBtn = document.getElementById('confirm-ok-btn');
    const cancelBtn = document.getElementById('confirm-cancel-btn');

    const cleanup = (result) => {
      document.getElementById('confirm-overlay').classList.remove('open');
      okBtn.replaceWith(okBtn.cloneNode(true));
      cancelBtn.replaceWith(cancelBtn.cloneNode(true));
      resolve(result);
    };

    document.getElementById('confirm-ok-btn').onclick = () => cleanup(true);
    document.getElementById('confirm-cancel-btn').onclick = () => cleanup(false);
  });
}

function openLegal(type) {
  const isTerms = type === 'terms';
  document.getElementById('legal-title').textContent = isTerms ? '利用規約' : 'プライバシーポリシー';
  document.getElementById('legal-body').innerHTML = isTerms ? TERMS_HTML : PRIVACY_HTML;
  document.getElementById('legal-overlay').classList.add('open');
}

const TERMS_HTML = `
<p style="font-family:'IBM Plex Mono',monospace;font-size:0.55rem;color:#aaa;margin-bottom:2rem;">最終更新日：2026年2月27日（暫定版）</p>

<h3 style="font-family:'IBM Plex Mono',monospace;font-size:0.65rem;letter-spacing:0.2em;color:#fff;margin:1.5rem 0 0.5rem;">第1条（適用）</h3>
<p>本利用規約（以下「本規約」）は、BLACK BOX（以下「本サービス」）の利用条件を定めるものです。ユーザーの皆さまには、本規約に従って本サービスをご利用いただきます。</p>

<h3 style="font-family:'IBM Plex Mono',monospace;font-size:0.65rem;letter-spacing:0.2em;color:#fff;margin:1.5rem 0 0.5rem;">第2条（サービスの概要）</h3>
<p>本サービスは、未完成の漫画・小説作品の著作権を第三者に完全譲渡するためのプラットフォームです。作品の投稿・閲覧・購入（著作権譲受）の場を提供します。</p>

<h3 style="font-family:'IBM Plex Mono',monospace;font-size:0.65rem;letter-spacing:0.2em;color:#fff;margin:1.5rem 0 0.5rem;">第3条（著作権の譲渡）</h3>
<p>1. 投稿者（譲渡人）は、決済完了時点をもって、当該作品に関するすべての著作権（著作財産権）を購入者（譲受人）に完全に譲渡するものとします。</p>
<p>2. 著作者人格権は譲渡できないものとされていますが、投稿者は購入者に対して著作者人格権を行使しないものとします。</p>
<p>3. 決済完了後、投稿者は当該作品に対する一切の権利を主張できません。</p>
<p>4. 購入者は譲受した著作権について、続編制作・商用利用・再販売を含むすべての利用が可能です。</p>

<h3 style="font-family:'IBM Plex Mono',monospace;font-size:0.65rem;letter-spacing:0.2em;color:#fff;margin:1.5rem 0 0.5rem;">第4条（投稿者の義務）</h3>
<p>1. 投稿者は、投稿する作品が自己の創作物であり、第三者の権利を侵害していないことを保証します。</p>
<p>2. 第三者のキャラクターや著作物を無断使用した作品の投稿は禁止します。</p>
<p>3. 投稿者は第三者から権利侵害の申し立てがあった場合、自己の責任と費用で対処するものとします。</p>

<h3 style="font-family:'IBM Plex Mono',monospace;font-size:0.65rem;letter-spacing:0.2em;color:#fff;margin:1.5rem 0 0.5rem;">第5条（禁止事項）</h3>
<p>以下の行為を禁止します。</p>
<p>・第三者の著作権・商標権等を侵害するコンテンツの投稿<br>・わいせつ・暴力的・差別的なコンテンツの投稿<br>・虚偽の情報の登録・投稿<br>・本サービスの運営を妨害する行為<br>・その他、運営が不適切と判断する行為</p>

<h3 style="font-family:'IBM Plex Mono',monospace;font-size:0.65rem;letter-spacing:0.2em;color:#fff;margin:1.5rem 0 0.5rem;">第6条（手数料）</h3>
<p>本サービスは、作品の譲渡成立時に取引金額の一定割合をプラットフォーム手数料として徴収します。手数料率は別途定めるものとします。</p>

<h3 style="font-family:'IBM Plex Mono',monospace;font-size:0.65rem;letter-spacing:0.2em;color:#fff;margin:1.5rem 0 0.5rem;">第7条（免責事項）</h3>
<p>1. 運営は、本サービスを通じた取引において生じた損害について、故意または重過失がある場合を除き責任を負いません。</p>
<p>2. 投稿者と購入者の間のトラブルについて、運営は仲介の義務を負いません。</p>
<p>3. 本サービスは現在テスト運用中であり、予告なく内容を変更・停止する場合があります。</p>

<h3 style="font-family:'IBM Plex Mono',monospace;font-size:0.65rem;letter-spacing:0.2em;color:#fff;margin:1.5rem 0 0.5rem;">第8条（規約の変更）</h3>
<p>運営は必要に応じて本規約を変更できるものとします。変更後の規約はサービス上に掲示した時点から効力を持ちます。</p>

<h3 style="font-family:'IBM Plex Mono',monospace;font-size:0.65rem;letter-spacing:0.2em;color:#fff;margin:1.5rem 0 0.5rem;">第9条（準拠法・管轄）</h3>
<p>本規約は日本法に準拠し、紛争が生じた場合は運営者の所在地を管轄する裁判所を専属的合意管轄とします。</p>
`;

const PRIVACY_HTML = `
<p style="font-family:'IBM Plex Mono',monospace;font-size:0.55rem;color:#aaa;margin-bottom:2rem;">最終更新日：2026年2月27日（暫定版）</p>

<h3 style="font-family:'IBM Plex Mono',monospace;font-size:0.65rem;letter-spacing:0.2em;color:#fff;margin:1.5rem 0 0.5rem;">第1条（取得する情報）</h3>
<p>本サービスでは以下の情報を取得します。</p>
<p>・メールアドレス（アカウント登録時）<br>・ペンネーム・自己紹介文（任意入力）<br>・プロフィール画像（任意アップロード）<br>・投稿した作品データ<br>・サービス利用履歴</p>

<h3 style="font-family:'IBM Plex Mono',monospace;font-size:0.65rem;letter-spacing:0.2em;color:#fff;margin:1.5rem 0 0.5rem;">第2条（利用目的）</h3>
<p>取得した情報は以下の目的で使用します。</p>
<p>・サービスの提供・運営<br>・ユーザーへの通知・連絡<br>・不正利用の防止<br>・サービスの改善</p>

<h3 style="font-family:'IBM Plex Mono',monospace;font-size:0.65rem;letter-spacing:0.2em;color:#fff;margin:1.5rem 0 0.5rem;">第3条（第三者提供）</h3>
<p>以下の場合を除き、取得した情報を第三者に提供しません。</p>
<p>・ユーザー本人の同意がある場合<br>・法令に基づく場合<br>・決済処理のためにPAY.JPに提供する場合</p>

<h3 style="font-family:'IBM Plex Mono',monospace;font-size:0.65rem;letter-spacing:0.2em;color:#fff;margin:1.5rem 0 0.5rem;">第4条（データの管理）</h3>
<p>本サービスはSupabase（米国）のインフラを利用してデータを管理しています。適切なセキュリティ対策を講じていますが、完全な安全性を保証するものではありません。</p>

<h3 style="font-family:'IBM Plex Mono',monospace;font-size:0.65rem;letter-spacing:0.2em;color:#fff;margin:1.5rem 0 0.5rem;">第5条（開示・削除）</h3>
<p>ユーザーは自己の情報の開示・訂正・削除を運営に請求できます。退会時にはアカウント情報を削除します。</p>

<h3 style="font-family:'IBM Plex Mono',monospace;font-size:0.65rem;letter-spacing:0.2em;color:#fff;margin:1.5rem 0 0.5rem;">第6条（お問い合わせ）</h3>
<p>プライバシーに関するお問い合わせは、サービス内のお問い合わせ窓口までご連絡ください。</p>
`;

function closeOverlay(id) {
  document.getElementById(id).classList.remove('open');
}

document.querySelectorAll('.overlay').forEach(el => {
  el.addEventListener('click', e => {
    if (e.target !== el) return;
    if (el.id === 'post-overlay') { closePost(); }
    else { el.classList.remove('open'); }
  });
});

async function submitWork() {
  if (!currentUser) { toast('ログインが必要です'); return; }
  const title    = document.getElementById('f-title').value.trim();
  const synopsis = document.getElementById('f-synopsis').value.trim();
  const price    = parseInt(document.getElementById('f-price').value);
  const format   = document.getElementById('f-format').value;

  if (!title || !synopsis) {
    toast('タイトルとあらすじを入力してください');
    return;
  }

  // 続編モードならseriesIdを引き継ぎ、episodeをインクリメント
  let seriesId, episode;
  if (sequelSourceWork) {
    seriesId = sequelSourceWork.seriesId || sequelSourceWork.series_id;
    const prevEpisodes = works.filter(w => w.seriesId === seriesId || w.series_id === seriesId);
    episode = prevEpisodes.length + 1;
  } else {
    seriesId = `series-${Date.now()}`;
    episode  = 1;
  }

  // ローディング表示
  const submitBtn  = document.getElementById('f-submit-btn');
  const loadingEl  = document.getElementById('f-loading');
  const loadingTxt = document.getElementById('f-loading-text');
  const progressEl = document.getElementById('f-loading-progress');
  const showLoading = (msg, pct) => {
    loadingEl.style.display = 'block';
    loadingTxt.textContent  = msg;
    progressEl.style.width  = pct + '%';
    submitBtn.disabled      = true;
    submitBtn.textContent   = '処理中...';
  };
  const hideLoading = () => {
    loadingEl.style.display = 'none';
    submitBtn.disabled      = false;
    submitBtn.textContent   = '投稿する →';
  };

  // 漫画の場合はmangaFileOrderの順番でアップロード
  let mangaPages = [];
  if (format === 'manga') {
    const files = mangaFileOrder.length > 0 ? mangaFileOrder : [...document.getElementById('f-manga-files').files];
    if (files.length > 0) {
      showLoading('原稿をアップロード中... 0%', 0);
      const folderName = `${currentUser.id}_${Date.now()}`;
      let completed = 0;
      const uploadPromises = files.map((file, i) => {
        const ext  = file.name.split('.').pop().toLowerCase();
        const path = `${folderName}/${String(i+1).padStart(3,'0')}.${ext}`;
        return db.storage.from('manga').upload(path, file, { contentType: file.type, upsert: true })
          .then(({ error }) => {
            if (error) throw new Error(error.message);
            completed++;
            const pct = Math.round(completed / files.length * 100);
            showLoading(`原稿をアップロード中... ${pct}%`, pct);
            return db.storage.from('manga').getPublicUrl(path).data.publicUrl;
          });
      });
      try {
        mangaPages = await Promise.all(uploadPromises);
        showLoading('投稿を保存中...', 100);
      } catch (e) {
        hideLoading();
        toast('アップロード失敗: ' + e.message);
        return;
      }
    }
  }

  // 小説の場合は本文をbodyに変換
  let novelBody = null;
  if (format === 'novel') {
    const raw = document.getElementById('f-body').value.trim();
    if (raw) {
      novelBody = raw.split(/\n{2,}/).map(p => p.trim()).filter(p => p);
    }
  }

  const newWork = {
    title,
    format,
    genre:     document.getElementById('f-genre').value || '未設定',
    author:    currentUser.name,
    author_id: currentUser.id,
    synopsis,
    price,
    date:      new Date().toISOString().slice(0, 10),
    status:    'available',
    likes:     0,
    body:      mangaPages.length > 0 ? mangaPages : (novelBody || null),
    series_id: seriesId,
    episode,
  };

  const { data, error } = await db.from('works').insert(newWork).select().single();
  if (error) { hideLoading(); toast('投稿に失敗しました: ' + error.message); return; }

  works.unshift({ ...data, comments: [], liked: false, seriesId: data.series_id });

  currentUser.posts = (currentUser.posts || 0) + 1;
  await db.from('profiles').update({ posts: currentUser.posts }).eq('id', currentUser.id);

  // 下書きを削除
  await db.from('drafts').delete().eq('user_id', currentUser.id);

  hideLoading();
  closeOverlay('post-overlay');
  sequelSourceWork = null;
  document.getElementById('f-modal-label').textContent = '新規投稿';
  document.getElementById('f-normal-fields').style.display = 'block';
  document.getElementById('f-sequel-info').style.display = 'none';
  window.scrollTo({ top: 0, behavior: 'smooth' });
  render();
  toast(`「${title}」を投稿しました`);
  ['f-title','f-genre','f-synopsis','f-price','f-body'].forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
  document.getElementById('f-manga-files').value = '';
  document.getElementById('f-manga-preview').innerHTML = '';
  document.getElementById('f-manga-hint').style.display = 'none';
  mangaFileOrder = [];
}

// フォームからプレビューを開く（漫画・小説両対応）
function openPreviewFromForm() {
  const format = document.getElementById('f-format').value;
  const title  = document.getElementById('f-title').value.trim() || '（タイトル未入力）';
  const genre  = document.getElementById('f-genre').value.trim() || '未設定';
  const author = currentUser ? currentUser.name : '匿名';
  const today  = new Date().toISOString().slice(0, 10);
  const bodyEl = document.getElementById('pv-body');

  if (format === 'manga' && mangaFileOrder.length > 0) {
    const imgs = mangaFileOrder.map(f => `<img src="${URL.createObjectURL(f)}" style="width:100%;max-width:720px;display:block;margin:0 auto;" loading="lazy">`).join('');
    bodyEl.innerHTML = `
      <h1>${title}</h1>
      <div class="reader-meta">by ${author} &nbsp;|&nbsp; ${genre} &nbsp;|&nbsp; ${today}</div>
      <div style="margin-top:1.5rem;">${imgs}</div>
    `;
  } else if (format === 'novel') {
    const raw  = document.getElementById('f-body').value.trim();
    const body = raw ? raw.split(/\n{2,}/).map(p => p.trim()).filter(p => p) : [];
    bodyEl.innerHTML = `
      <h1>${title}</h1>
      <div class="reader-meta">by ${author} &nbsp;|&nbsp; ${genre} &nbsp;|&nbsp; ${today}</div>
      ${body.length > 0
        ? body.map(p => `<p class="reader-paragraph">${p.replace(/\n/g, '<br>')}</p>`).join('')
        : '<p class="reader-paragraph" style="color:#aaa;">（本文はまだありません）</p>'
      }
    `;
  } else {
    toast('プレビューする内容がありません');
    return;
  }

  const page = document.getElementById('preview-page');
  page.scrollTop = 0;
  page.classList.add('open');
  document.body.style.overflow = 'hidden';
}

// 下書き保存
async function saveDraft() {
  if (!currentUser) { toast('ログインが必要です'); return; }
  const draft = {
    user_id:  currentUser.id,
    title:    document.getElementById('f-title').value,
    genre:    document.getElementById('f-genre').value,
    synopsis: document.getElementById('f-synopsis').value,
    price:    parseInt(document.getElementById('f-price').value) || 0,
    format:   document.getElementById('f-format').value,
    body:     document.getElementById('f-body') ? document.getElementById('f-body').value : '',
    updated_at: new Date().toISOString(),
  };

  // 既存の下書きがあればupsert
  const { data: existing } = await db.from('drafts').select('id').eq('user_id', currentUser.id).limit(1);
  const existingDraft = existing && existing.length > 0 ? existing[0] : null;
  if (existingDraft) {
    await db.from('drafts').update(draft).eq('id', existingDraft.id);
  } else {
    await db.from('drafts').insert(draft);
  }
  toast('下書きを保存しました');
}

// 下書き読み込み
async function loadDraft() {
  if (!currentUser) return;
  const { data: drafts } = await db.from('drafts').select('*').eq('user_id', currentUser.id).limit(1);
  const draft = drafts && drafts.length > 0 ? drafts[0] : null;
  if (!draft) return;

  document.getElementById('f-title').value    = draft.title || '';
  document.getElementById('f-genre').value    = draft.genre || '';
  document.getElementById('f-synopsis').value = draft.synopsis || '';
  document.getElementById('f-price').value    = draft.price || '';
  document.getElementById('f-format').value   = draft.format || 'manga';
  if (document.getElementById('f-body')) document.getElementById('f-body').value = draft.body || '';

  document.getElementById('f-title-count').textContent = (draft.title || '').length + '/40';
  document.getElementById('f-synopsis-count').textContent = (draft.synopsis || '').length + '/160';

  const formatEl   = document.getElementById('f-format');
  const mangaBlock = document.getElementById('f-manga-block');
  const novelBlock = document.getElementById('f-novel-block');
  mangaBlock.style.display = formatEl.value === 'manga' ? 'block' : 'none';
  novelBlock.style.display = formatEl.value === 'novel' ? 'block' : 'none';
}

// --- PREVIEW ---
function openPreview(source) {
  let title, genre, author, body;
  const today = new Date().toISOString().slice(0, 10);

  if (source === 'post') {
    title  = document.getElementById('f-title').value.trim() || '（タイトル未入力）';
    genre  = document.getElementById('f-genre').value.trim() || '未設定';
    author = currentUser ? currentUser.name : (document.getElementById('f-author').value.trim() || '匿名');
    body   = null;
  } else if (source === 'edit') {
    const w = works.find(x => x.id === currentId);
    title  = document.getElementById('e-title').value.trim() || w?.title || '';
    genre  = document.getElementById('e-genre').value.trim() || '未設定';
    author = w?.author || '';
    const format = document.getElementById('e-format').value;

    if (format === 'manga' && editMangaPages.length > 0) {
      // 漫画：editMangaPages（URL or File）からプレビュー
      const bodyEl = document.getElementById('pv-body');
      const imgs = editMangaPages.map(p => {
        const src = p.type === 'url' ? p.value : URL.createObjectURL(p.value);
        return `<img src="${src}" style="width:100%;max-width:720px;display:block;margin:0 auto;" loading="lazy">`;
      }).join('');
      bodyEl.innerHTML = `
        <h1>${title}</h1>
        <div class="reader-meta">by ${author} &nbsp;|&nbsp; ${genre} &nbsp;|&nbsp; ${today}</div>
        <div style="margin-top:1.5rem;">${imgs}</div>
      `;
      const page = document.getElementById('preview-page');
      page.scrollTop = 0;
      page.classList.add('open');
      document.body.style.overflow = 'hidden';
      return;
    } else if (format === 'novel') {
      const raw = document.getElementById('e-body').value.trim();
      body = raw ? raw.split(/\n{2,}/).map(p => p.trim()).filter(p => p) : w?.body || null;
    } else {
      body = w?.body || null;
    }
  } else if (source === 'text') {
    const w = works.find(x => x.id === currentId);
    title  = w?.title || '';
    genre  = w?.genre || '';
    author = w?.author || '';
    const raw = document.getElementById('text-edit-input').value.trim();
    body = raw ? raw.split(/\n{2,}/).map(p => p.trim()).filter(p => p) : w?.body || null;
  }

  const bodyEl = document.getElementById('pv-body');
  if (body && body.length > 0) {
    bodyEl.innerHTML = `
      <h1>${title}</h1>
      <div class="reader-meta">by ${author} &nbsp;|&nbsp; ${genre} &nbsp;|&nbsp; ${today}</div>
      ${body.map(p => `<p class="reader-paragraph">${p.replace(/\n/g, '<br>')}</p>`).join('')}
    `;
  } else {
    bodyEl.innerHTML = `
      <h1>${title}</h1>
      <div class="reader-meta">by ${author} &nbsp;|&nbsp; ${genre} &nbsp;|&nbsp; ${today}</div>
      <p class="reader-paragraph" style="color:#aaa;">（本文はまだありません）</p>
    `;
  }

  const page = document.getElementById('preview-page');
  page.scrollTop = 0;
  page.classList.add('open');
  document.body.style.overflow = 'hidden';
}
function openOverview(id) {
  const w = works.find(x => x.id === id);
  if (!w) return;
  currentId = id;

  const formatLabel = document.getElementById('ov-format-label');
  formatLabel.textContent = w.format === 'manga' ? '漫画' : '小説';
  formatLabel.className = `work-format-badge ${w.format}`;
  document.getElementById('ov-genre').textContent = w.genre;
  document.getElementById('ov-title').textContent = w.title;
  const authorEl = document.getElementById('ov-author');
  authorEl.textContent = w.author;
  authorEl.dataset.name = w.author;

  // 概要ページの作者アイコン更新
  const ovAuthorIcon = document.getElementById('ov-author-icon');
  if (ovAuthorIcon) {
    const av = avatarCache[w.author];
    ovAuthorIcon.innerHTML = av
      ? `<img src="${av}" style="width:100%;height:100%;object-fit:cover;">`
      : `<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="#777" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 3.6-7 8-7s8 3 8 7"/></svg>`;
  }
  document.getElementById('ov-date').textContent = w.date;
  document.getElementById('ov-synopsis').textContent = w.synopsis;
  document.getElementById('ov-price').textContent = w.price === 0 ? '¥0' : `¥${w.price.toLocaleString()}`;

  // 編集ボタン：本人のみ
  document.getElementById('ov-edit-btn').style.display =
    (currentUser && currentUser.name === w.author) ? 'block' : 'none';

  // 話数リスト（シリーズのみ）
  const epListEl = document.getElementById('ov-ep-list');
  if (w.seriesId) {
    const episodes = getSeriesEpisodes(w.seriesId);
    epListEl.style.display = 'block';
    epListEl.innerHTML = `
      <div style="font-family:'IBM Plex Mono',monospace;font-size:0.5rem;color:#aaa;letter-spacing:0.2em;margin-bottom:0.6rem;">バックナンバー</div>
      ${[...episodes].reverse().map(ep => {
        const isLatest = ep.id === episodes[episodes.length - 1].id;
        const daysSince = (Date.now() - new Date(ep.date).getTime()) / (1000 * 60 * 60 * 24);
        const showNew = isLatest && daysSince <= 14;
        return `
        <div class="ep-row">
          <div class="ep-row-info">
            <div class="ep-row-num">${ep.episode}話${showNew ? ' <span class="new-badge">NEW</span>' : ''}</div>
            <div style="font-size:0.82rem;color:#ccc;">${ep.title}</div>
            <div class="ep-row-author">by ${ep.author} · ${ep.date}</div>
          </div>
          <button class="ep-row-read" onclick="closeOverlay('overview-overlay'); currentId=${ep.id}; openReader(${ep.id});">作品を読む →</button>
        </div>`;
      }).join('')}
    `;
  } else {
    epListEl.style.display = 'none';
  }

  updateOverviewReactions(w);

  // 取得ボタンの状態制御
  const ovAcquireBtn = document.getElementById('ov-acquire-btn');
  if (w.status === 'sold') {
    ovAcquireBtn.textContent = '譲渡済み';
    ovAcquireBtn.style.background = '#222';
    ovAcquireBtn.style.color = '#555';
    ovAcquireBtn.style.cursor = 'default';
    ovAcquireBtn.onclick = null;
  } else if (!currentUser) {
    ovAcquireBtn.textContent = 'ログインして続きを書く';
    ovAcquireBtn.style.background = '#333';
    ovAcquireBtn.style.color = '#888';
    ovAcquireBtn.style.cursor = 'pointer';
    ovAcquireBtn.onclick = () => { closeOverlay('overview-overlay'); openLogin(); };
  } else if (w.author_id === currentUser.id) {
    ovAcquireBtn.textContent = '自分の作品';
    ovAcquireBtn.style.background = '#222';
    ovAcquireBtn.style.color = '#555';
    ovAcquireBtn.style.cursor = 'default';
    ovAcquireBtn.onclick = null;
  } else {
    ovAcquireBtn.textContent = '続きを書く →';
    ovAcquireBtn.style.background = 'var(--white)';
    ovAcquireBtn.style.color = 'var(--black)';
    ovAcquireBtn.style.cursor = 'pointer';
    ovAcquireBtn.onclick = acquireAndWrite;
  }

  document.getElementById('overview-overlay').classList.add('open');
}

function updateOverviewReactions(w) {
  document.getElementById('ov-like-icon').textContent = w.liked ? '♥' : '♡';
  document.getElementById('ov-like-count').textContent = w.likes;
  document.getElementById('ov-like-btn').style.borderColor = w.liked ? '#e44' : 'var(--border)';
  document.getElementById('ov-like-btn').style.color = w.liked ? '#e44' : '#aaa';
  document.getElementById('ov-comment-count').textContent = (w.comments || []).length;

  const list = document.getElementById('ov-comments-list');
  if (!w.comments || w.comments.length === 0) {
    list.innerHTML = `<p style="font-family:'IBM Plex Mono',monospace;font-size:0.65rem;color:#444;letter-spacing:0.05em;">まだコメントはありません</p>`;
  } else {
    list.innerHTML = w.comments.map(c => {
      const canDelete = currentUser && (currentUser.name === c.author || currentUser.id === w.author_id);
      return `
        <div style="border-bottom:1px solid var(--border);padding-bottom:1rem;">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:0.4rem;">
            <div style="font-family:'IBM Plex Mono',monospace;font-size:0.6rem;color:#aaa;">${c.author} · ${c.date}</div>
            ${canDelete ? `
              <button onclick="deleteComment(${c.id})" title="削除" style="background:none;border:none;cursor:pointer;padding:0.2rem;color:var(--red);display:flex;align-items:center;opacity:0.7;transition:opacity 0.2s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'">
                <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4h6v2"/></svg>
              </button>
            ` : ''}
          </div>
          <div style="font-size:0.85rem;color:#ccc;line-height:1.8;">${c.text}</div>
        </div>
      `;
    }).join('');
  }
  document.getElementById('ov-comment-form').style.display = currentUser ? 'block' : 'none';
  document.getElementById('ov-comment-login').style.display = currentUser ? 'none' : 'block';
}

function toggleLikeFromOverview() {
  if (!currentUser) { toast('ログインが必要です'); return; }
  const w = works.find(x => x.id === currentId);
  if (!w) return;
  w.liked = !w.liked;
  w.likes += w.liked ? 1 : -1;
  updateOverviewReactions(w);
  render();
}

async function submitOverviewComment() {
  if (!currentUser) return;
  const input = document.getElementById('ov-comment-input');
  const text = input.value.trim();
  if (!text) return;
  const w = works.find(x => x.id === currentId);
  if (!w) return;
  const now = new Date();
  const date = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;

  const { data, error } = await db.from('comments').insert({
    work_id: w.id,
    author:  currentUser.name,
    text,
    date,
    user_id: currentUser.id,
  }).select().single();

  if (error) { toast('コメントの投稿に失敗しました'); return; }

  if (!w.comments) w.comments = [];
  w.comments.push(data);
  input.value = '';
  updateOverviewReactions(w);
  openOverview(currentId);
  render();
}

async function deleteComment(commentId) {
  const w = works.find(x => x.id === currentId);
  if (!w) return;

  const { error } = await db.from('comments').delete().eq('id', commentId);
  if (error) { toast('削除に失敗しました'); return; }

  w.comments = w.comments.filter(c => c.id !== commentId);
  updateOverviewReactions(w);
  openOverview(currentId);
  render();
  toast('コメントを削除しました');
}

// 概要モーダルから読書ページへ
async function acquireWork() {
  if (!currentUser) { toast('ログインが必要です'); return; }
  const w = works.find(x => x.id === currentId);
  if (!w) return;
  if (w.status === 'sold') { toast('この作品はすでに譲渡済みです'); return; }
  if (w.author_id === currentUser.id) { toast('自分の作品は取得できません'); return; }

  const ok = await showConfirm(
    '著作権を取得する',
    `「${w.title}」の著作権を取得しますか？<br>続編・商用利用・再販すべて可能になります。この操作は取り消せません。`,
    '取得する →'
  );
  if (!ok) return;

  const { error } = await db.from('works')
    .update({ status: 'sold', buyer_id: currentUser.id, acquired_at: new Date().toISOString() })
    .eq('id', w.id);

  if (error) { toast('取得に失敗しました'); return; }

  // ローカルも更新
  w.status = 'sold';
  w.buyer_id = currentUser.id;

  // 元の作者の譲渡実績を+1
  await db.from('profiles')
    .update({ transfers: (await db.from('profiles').select('transfers').eq('id', w.author_id).single()).data.transfers + 1 })
    .eq('id', w.author_id);

  toast('著作権を取得しました！続きを自由に書いてください');
  closeOverlay('detail-overlay');
  closeOverlay('overview-overlay');
  render();
}

function readFromOverview() {
  closeOverlay('overview-overlay');
  directRead(currentId);
}

// カードの「作品を読む」から直で読書ページへ
function directRead(id) {
  const w = works.find(x => x.id === id);
  if (!w) return;
  currentId = id;
  if (w.mangaUrl) {
    window.location.href = w.mangaUrl;
    return;
  }
  if (w.body) {
    openReader(id);
  } else {
    toast('本文はまだ公開されていません');
  }
}

// --- READER ---
function openReader(id) {
  const w = works.find(x => x.id === id);
  if (!w || !w.body) return;
  currentId = id;

  const epLabel = w.seriesId ? ` ${w.episode}話` : '';
  const fullTitle = `${w.title}${epLabel}`;

  document.getElementById('r-page-title').textContent = fullTitle;

  // 漫画（画像URL配列）か小説（テキスト配列）かで表示を切り替え
  const isMangaImages = w.format === 'manga' && Array.isArray(w.body) && w.body.length > 0 && w.body[0].startsWith('http');

  if (isMangaImages) {
    document.getElementById('r-body').innerHTML = `
      <h1>${fullTitle}</h1>
      <div class="reader-meta">by ${w.author} &nbsp;|&nbsp; ${w.genre} &nbsp;|&nbsp; ${w.date}</div>
      <div style="display:flex;flex-direction:column;gap:0;margin-top:1.5rem;">
        ${w.body.map(url => `<img src="${url}" style="width:100%;max-width:720px;display:block;margin:0 auto;" loading="lazy">`).join('')}
      </div>
      <p style="font-family:'Noto Serif JP',serif;font-size:1rem;color:#111;letter-spacing:0.2em;margin-top:2.5rem;margin-bottom:0.5rem;">— つづく —</p>
    `;
  } else {
    document.getElementById('r-body').innerHTML = `
      <h1>${fullTitle}</h1>
      <div class="reader-meta">by ${w.author} &nbsp;|&nbsp; ${w.genre} &nbsp;|&nbsp; ${w.date}</div>
      ${w.body.map(p => `<p class="reader-paragraph">${p.replace(/\n/g, '<br>')}</p>`).join('')}
      <p style="font-family:'Noto Serif JP',serif;font-size:1rem;color:#111;letter-spacing:0.2em;margin-top:2.5rem;margin-bottom:0.5rem;">— つづく —</p>
    `;
  }
  // バーのいいね・コメント数を同期
  updateReaderBar(w);

  const page = document.getElementById('reader-page');
  page.scrollTop = 0;
  page.classList.add('open');
  document.body.style.overflow = 'hidden';

  // スクロール末尾でバーを表示。次話があれば「続きを読む」、なければ「続きを書く」
  const bar = document.getElementById('r-sequel-bar');
  bar.style.display = 'none';

  // 次話を探す
  const nextEp = w.seriesId
    ? getSeriesEpisodes(w.seriesId).find(ep => ep.episode === w.episode + 1)
    : null;

  // バーの文言とボタンを切り替え
  const barMsg  = bar.querySelector('div > div:last-child');
  const writeBtn = bar.querySelector('button:last-child');
  if (nextEp) {
    barMsg.textContent = `${nextEp.episode}話が公開されています`;
    writeBtn.textContent = `続きを読む →`;
    writeBtn.onclick = () => { closeReader(); openReader(nextEp.id); };
  } else {
    barMsg.textContent = 'この作品の続きを書きませんか？';
    writeBtn.textContent = '続きを書く →';
    writeBtn.onclick = acquireAndWrite;
  }

  page.onscroll = () => {
    const nearBottom = page.scrollTop + page.clientHeight >= page.scrollHeight - 80;
    bar.style.display = nearBottom ? 'flex' : 'none';
  };
}

function updateReaderBar(w) {
  document.getElementById('r-like-icon').textContent = w.liked ? '♥' : '♡';
  document.getElementById('r-like-count').textContent = w.likes;
  document.getElementById('r-like-btn').style.borderColor = w.liked ? '#e44' : '#ccc';
  document.getElementById('r-like-btn').style.color = w.liked ? '#e44' : '#555';
  document.getElementById('r-comment-count').textContent = (w.comments || []).length;
}

function toggleLikeFromReader() {
  if (!currentUser) { toast('ログインが必要です'); return; }
  const w = works.find(x => x.id === currentId);
  if (!w) return;
  w.liked = !w.liked;
  w.likes += w.liked ? 1 : -1;
  updateReaderBar(w);
  render();
}

function openCommentFromReader() {
  // 概要ページのコメント欄へ戻る
  closeReader();
  // detail-pageが開いていない場合は開く
  if (!document.getElementById('detail-page').classList.contains('open')) {
    openOverview(currentId);
  }
  // コメント入力欄へスクロール
  setTimeout(() => {
    const el = document.getElementById('dp-comment-input') || document.getElementById('dp-comment-login');
    if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
    if (document.getElementById('dp-comment-input')) document.getElementById('dp-comment-input').focus();
  }, 150);
}

function closeReader() {
  document.getElementById('reader-page').classList.remove('open');
  document.getElementById('reader-page').onscroll = null;
  document.getElementById('r-sequel-bar').style.display = 'none';
  document.body.style.overflow = '';
}

function openReaderFromDetail() {
  closeOverlay('detail-overlay');
  openReader(currentId);
}

// 続きを書く → 権利取得
let sequelSourceWork = null; // 続編元の作品

async function acquireAndWrite() {
  if (!currentUser) { toast('ログインが必要です'); return; }
  const w = works.find(x => x.id === currentId);
  if (!w) return;
  if (w.status === 'sold') { toast('この作品はすでに譲渡済みです'); return; }
  if (w.author_id === currentUser.id) { toast('自分の作品の続きは書けません'); return; }

  const ok = await showConfirm(
    '続編を書く権利を取得する',
    `「${w.title}」の権利を取得しますか？<br>取得後は続きを自由に書けます。この操作は取り消せません。`,
    '取得して続きを書く →'
  );
  if (!ok) return;

  // Supabaseを更新
  const { error } = await db.from('works')
    .update({ status: 'sold', buyer_id: currentUser.id, acquired_at: new Date().toISOString() })
    .eq('id', w.id);
  if (error) { toast('取得に失敗しました'); return; }

  // 前話作者の譲渡実績を+1
  const { data: authorProfile } = await db.from('profiles').select('transfers').eq('id', w.author_id).single();
  if (authorProfile) {
    await db.from('profiles').update({ transfers: authorProfile.transfers + 1 }).eq('id', w.author_id);
  }

  // ローカル更新
  w.status = 'sold';
  w.buyer_id = currentUser.id;

  // 続編フォームを開く
  sequelSourceWork = w;
  closeReader();
  closePage('detail-page');
  closeOverlay('overview-overlay');
  render();
  openSequelPost(w);
  toast(`「${w.title}」の権利を取得しました`);
}

function openSequelPost(w) {
  // フォームをリセット（closePostは呼ばない）
  mangaFileOrder = [];
  document.getElementById('f-manga-files').value = '';
  document.getElementById('f-manga-preview').innerHTML = '';
  document.getElementById('f-manga-hint').style.display = 'none';
  ['f-title','f-genre','f-synopsis','f-body'].forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
  document.getElementById('f-synopsis-count').textContent = '0/160';

  // 続編モードのUI
  document.getElementById('f-modal-label').textContent = '続編を投稿';
  document.getElementById('f-normal-fields').style.display = 'none';
  document.getElementById('f-sequel-info').style.display = 'block';

  // 固定情報を表示
  const badge = document.getElementById('f-sequel-format-badge');
  badge.textContent = w.format === 'manga' ? '漫画' : '小説';
  badge.className = `work-format-badge ${w.format}`;
  document.getElementById('f-sequel-title').textContent = w.title;
  document.getElementById('f-sequel-genre').textContent = w.genre;

  // 隠しフィールドにセット
  document.getElementById('f-title').value  = w.title;
  document.getElementById('f-genre').value  = w.genre;
  document.getElementById('f-format').value = w.format;

  // 形式に合わせてブロック表示
  const mangaBlock = document.getElementById('f-manga-block');
  const novelBlock = document.getElementById('f-novel-block');
  mangaBlock.style.display = w.format === 'manga' ? 'block' : 'none';
  novelBlock.style.display = w.format === 'novel' ? 'block' : 'none';

  document.getElementById('post-overlay').classList.add('open');
}

function acquireFromPage() {
  acquireAndWrite();
}

function acquireFromCard(id) {
  currentId = id;
  acquireAndWrite();
}

function toggleLike(id) {
  if (!currentUser) { toast('ログインが必要です'); return; }
  const w = works.find(x => x.id === id);
  if (!w) return;
  w.liked = !w.liked;
  w.likes += w.liked ? 1 : -1;
  render();
}

// --- EDIT ---
// 編集中の漫画ページ管理（URLとFileの混合配列）
let editMangaPages = []; // { type: 'url'|'file', value: url|File }
let editDragSrcIndex = null;

function openEditOverlay() {
  const w = works.find(x => x.id === currentId);
  if (!w || !currentUser || currentUser.id !== w.author_id) return;
  if (w.status === 'sold') { toast('譲渡済みの作品は編集できません'); return; }

  document.getElementById('e-title').value   = w.title;
  document.getElementById('e-format').value  = w.format;
  document.getElementById('e-genre').value   = w.genre;
  document.getElementById('e-synopsis').value = w.synopsis;
  document.getElementById('e-price').value = w.price;
  document.getElementById('e-price-display').textContent = `¥${w.price.toLocaleString()}`;

  const novelBlock = document.getElementById('e-novel-block');
  const mangaBlock = document.getElementById('e-manga-block');

  if (w.format === 'novel') {
    novelBlock.style.display = 'block';
    mangaBlock.style.display = 'none';
    const bodyEl = document.getElementById('e-body');
    bodyEl.value = w.body ? w.body.join('\n\n') : '';
  } else {
    novelBlock.style.display = 'none';
    mangaBlock.style.display = 'block';
    // 既存URLを読み込む
    editMangaPages = (w.body || []).map(url => ({ type: 'url', value: url }));
    renderEditMangaPages();
  }

  document.getElementById('edit-overlay').classList.add('open');
}

function renderEditMangaPages() {
  const container = document.getElementById('e-manga-pages');
  container.innerHTML = '';
  editMangaPages.forEach((page, i) => {
    const src = page.type === 'url' ? page.value : URL.createObjectURL(page.value);
    const item = document.createElement('div');
    item.style.cssText = 'position:relative;cursor:grab;user-select:none;';
    item.draggable = true;
    item.dataset.index = i;
    item.innerHTML = `
      <img src="${src}" style="width:60px;height:80px;object-fit:cover;border:1px solid #333;display:block;">
      <div style="font-family:'IBM Plex Mono',monospace;font-size:0.4rem;color:#aaa;text-align:center;">${i+1}p</div>
      <button onclick="editMangaRemove(${i})" style="position:absolute;top:2px;right:2px;width:16px;height:16px;background:#900;border:none;color:#fff;font-size:0.55rem;cursor:pointer;line-height:1;padding:0;">×</button>
    `;
    item.addEventListener('dragstart', () => { editDragSrcIndex = i; item.style.opacity = '0.4'; });
    item.addEventListener('dragend',   () => { item.style.opacity = '1'; });
    item.addEventListener('dragover',  e => e.preventDefault());
    item.addEventListener('drop', () => {
      if (editDragSrcIndex === null || editDragSrcIndex === i) return;
      const moved = editMangaPages.splice(editDragSrcIndex, 1)[0];
      editMangaPages.splice(i, 0, moved);
      editDragSrcIndex = null;
      renderEditMangaPages();
    });
    container.appendChild(item);
  });
}

function editMangaRemove(i) {
  editMangaPages.splice(i, 1);
  renderEditMangaPages();
}

function editMangaAdd(input) {
  const newFiles = [...input.files].map(f => ({ type: 'file', value: f }));
  editMangaPages = [...editMangaPages, ...newFiles];
  renderEditMangaPages();
  input.value = '';
}

async function saveEdit() {
  const w = works.find(x => x.id === currentId);
  if (!w) return;
  const title    = document.getElementById('e-title').value.trim();
  const synopsis = document.getElementById('e-synopsis').value.trim();
  const price    = parseInt(document.getElementById('e-price').value);
  const genre    = document.getElementById('e-genre').value || '未設定';
  const format   = document.getElementById('e-format').value;

  if (!title || !synopsis || isNaN(price)) { toast('入力内容を確認してください'); return; }

  let body = w.body;

  if (format === 'novel') {
    const raw = document.getElementById('e-body').value.trim();
    body = raw ? raw.split(/\n{2,}/).map(p => p.trim()).filter(p => p) : null;
  } else if (format === 'manga') {
    // 新規ファイルをアップロードしてURLに変換
    toast('保存中...');
    const folderName = `${currentUser.id}_${w.id}`;
    const uploadedPages = await Promise.all(editMangaPages.map(async (page, i) => {
      if (page.type === 'url') return page.value;
      const ext  = page.value.name.split('.').pop().toLowerCase();
      const path = `${folderName}/${String(i+1).padStart(3,'0')}.${ext}`;
      const { error } = await db.storage.from('manga').upload(path, page.value, {
        contentType: page.value.type, upsert: true,
      });
      if (error) throw new Error(error.message);
      return db.storage.from('manga').getPublicUrl(path).data.publicUrl;
    }));
    body = uploadedPages;
  }

  const { error } = await db.from('works')
    .update({ title, synopsis, price, genre, format, body })
    .eq('id', w.id);

  if (error) { toast('更新失敗: ' + error.message); return; }

  w.title    = title;
  w.format   = format;
  w.genre    = genre;
  w.synopsis = synopsis;
  w.price    = price;
  w.body     = body;

  closeOverlay('edit-overlay');
  openOverview(currentId);
  render();
  toast('作品を更新しました');
}

function toast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 3000);
}

// --- 初期化（Supabaseからデータ取得） ---
async function init() {
  // セッション復元
  const { data: { session } } = await db.auth.getSession();
  if (session) await loadCurrentUser(session.user);

  // パスワードリセットリンクから戻ってきた場合
  db.auth.onAuthStateChange(async (event, session) => {
    if (event === 'PASSWORD_RECOVERY') {
      const newPassword = prompt('新しいパスワードを入力してください（6文字以上）');
      if (!newPassword || newPassword.length < 6) { toast('パスワードは6文字以上にしてください'); return; }
      const { error } = await db.auth.updateUser({ password: newPassword });
      if (error) { toast('変更失敗: ' + error.message); return; }
      toast('パスワードを変更しました');
    } else if (event === 'SIGNED_IN' && session && !currentUser) {
      await loadCurrentUser(session.user);
      render();
    } else if (event === 'SIGNED_OUT') {
      currentUser = null;
      updateAuthUI();
      render();
    }
  });

  // プロフィール（アバター）を一括キャッシュ
  const { data: profilesData } = await db.from('profiles').select('name, avatar_url');
  if (profilesData) {
    profilesData.forEach(p => { avatarCache[p.name] = p.avatar_url || null; });
  }

  // 作品をSupabaseから取得
  const { data: worksData } = await db.from('works')
    .select('*')
    .order('created_at', { ascending: false });

  if (worksData && worksData.length > 0) {
    // コメントも取得
    const { data: commentsData } = await db.from('comments').select('*');
    // いいねも取得
    const { data: likesData } = await db.from('likes').select('*');

    works = worksData.map(w => ({
      ...w,
      seriesId: w.series_id,
      comments: (commentsData || []).filter(c => c.work_id === w.id),
      liked: currentUser
        ? (likesData || []).some(l => l.work_id === w.id && l.user_name === currentUser.name)
        : false,
    }));
  }

  updateAuthUI();
  render();

  // ローディング画面をフェードアウト
  const loading = document.getElementById('loading-screen');
  loading.style.transition = 'opacity 0.4s';
  loading.style.opacity = '0';
  setTimeout(() => loading.style.display = 'none', 400);
}

init();
</script>
</body>
</html>
